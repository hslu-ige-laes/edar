% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Energy Data Analysis with R},
  pdfauthor={Reto Marek},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

%% change fontsize of R code
\let\oldShaded\Shaded
\let\endoldShaded\endShaded
\renewenvironment{Shaded}{\footnotesize\oldShaded}{\endoldShaded}

%% change fontsize of output
\let\oldverbatim\verbatim
\let\endoldverbatim\endverbatim
\renewenvironment{verbatim}{\footnotesize\oldverbatim}{\endoldverbatim}
\usepackage[]{natbib}
\bibliographystyle{apalike}

\title{Energy Data Analysis with R}
\author{Reto Marek}
\date{2020-11-27}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{preface}{%
\chapter{Preface}\label{preface}}

This book gives you an overview of the statistical software R and its ability to analyze and visualize time series in the context of building energy and comfort.

It is aimed at R beginners as well as exerienced R users and is strongly inspired by the \href{https://r-graphics.org/}{R Graphics Cookbook} and \href{https://smogdr.github.io/edar_coursebook/}{Engineering Data Analysis in R}. The aim of this book is to provide additional specific recipes for energy and comfort related tasks and to make your entry into R smooth and easy.

\hypertarget{content}{%
\section{Content}\label{content}}

The book is structured in the following main parts:

\begin{itemize}
\item
  R Basics
\item
  Data Visualizations
\end{itemize}

The part ``R Basics'' covers general data analysis tasks like data loading, wrangling and aggregation. Mostly this part deals with number juggling and table viewing. An ``R-beginner'' receives as well information about the installation of the program environment and gets a quick and practical introduction.

\begin{quote}
``Numerical quantities focus on expected values, graphical summaries on unexpected values.'' - John W. Tukey
\end{quote}

Such so called ``graphical summaries'' are covered in the part ``Data Visualizations'' which brings the calculated numbers to life. Visualizations are good to identify patterns, changes over time, unusual readings, and relationships between variables. The presented code makes the creation of common and useful plots for energy and comfort data fast and easy.
The recipes in this part will show you how to complete certain specific tasks. Examples are shown so that you can understand the basic principle and reproduce the analysis or visualization with your own data. Simply copy the code into your R-script, replace the sample data files with your own and execute the code.

\hypertarget{why-r-and-rstudio}{%
\section{Why R and RStudio?}\label{why-r-and-rstudio}}

In a study commissioned by the Swiss Federal Office of Energy, experts from the field were asked how and where they perform energy analyses and create visualizations. The result was that many people today either need Excel or use a building monitoring software to execute analysis and create visualizations.

Excel users are pushing the program to its limits with the ever-increasing data sets. Also the interactive ability of the graphics there is limited. The change to an environment like ``R'' seems to be difficult for many. In the market there are numerous books which make the change to ``R'' for other disciplines easier. However, experts from the energy and building services engineering industry lack a corresponding work. The present book is intended to close this gap.

The freely available programming language ``R'' and its graphical user interface ``RStudio'' offer many more possibilities for data analysis and data visualization.

\hypertarget{further-reading}{%
\section{Further Reading}\label{further-reading}}

A really good source is {[}R for Data Science{]}(\url{http://r4ds.had.co.nz}{]}\{target="\_blank"\} by Garrett Grolemund and Hadley Wickham. The entire book is freely available online through the same format of this book.

There are a number of recommendable free online books available, including:

\begin{itemize}
\tightlist
\item
  \href{https://r-graphics.org/}{R Graphics Cookbook}
\item
  \href{https://rafalab.github.io/dsbook/}{Introduction to Data Science - Data Analysis and Prediction Algorithms with R}
\item
  \href{https://rstudio-education.github.io/hopr/}{Hands-On Programming with R}
\item
  \href{https://smogdr.github.io/edar_coursebook/}{Engineering Data Analysis in R}
\item
  \href{https://otexts.com/fpp2/}{Forecasting: Principles and Practice}
\item
  \href{https://afit-r.github.io/}{AFIT Data Science Lab R Programming Guide}
\end{itemize}

\newpage

\hypertarget{acknowledgements}{%
\section{Acknowledgements}\label{acknowledgements}}

The author would like to express his sincere thank to the Swiss Federal Office of Energy, as the launch of this book was part of a project of the research program ``Buildings and Cities 2018''.

This book was developed using Yihui Xie's \href{https://bookdown.org}{bookdown} framework. The book is built using code that combines R code, data, and text to create a book for which R code and examples can be re-executed every time the book is re-built.

The online book is hosted using GitHub's free \href{https://pages.github.com}{GitHub Pages}. All material for this book is available and can be explored at the book's \href{https://github.com/hslu-ige-laes/edar}{GitHub repository}.

\hypertarget{getting-started}{%
\chapter{Getting started}\label{getting-started}}

Before we can start with the analysis described in the later chapters, we have to install ``R''.
Therefore the first two parts of this chapter get you up and running with downloading and installing the relevant software and packages.

This may seem laborious, but it is necessary and easier than it appears at first glance.

If you already have ``R'' and ``R Studio'' installed, please take a look at the \url{https://github.com/hslu-ige-laes/redutils} package on github, which is frequently used throughout this book. Chapter \ref{installationPackages} shows you how to install it.

Finally ``R-beginners'' find in \ref{createFirstScript} an easy code example which creates a simple time series plot.

\hypertarget{installation}{%
\section{Install R and R Studio}\label{installation}}

Before we can start the first analysis, we have to install ``R'' and ``RStudio''.

\begin{itemize}
\tightlist
\item
  ``R'' is a programming language used for statistical computing while ``RStudio'' provides a graphical user interface
\item
  ``R'' may be used without ``RStudio'', but ``RStudio'' may not be used without ``R''
\item
  Both, ``R'' and ``RStudio'' are free of charge and there are no licencse fees
\item
  When you later make an analysis and visualizations, you only work in the graphical user interface ``RStudio''
\end{itemize}

\newpage

\hypertarget{download-and-install-r}{%
\subsection{Download and Install R}\label{download-and-install-r}}

Windows

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Open \url{https://cran.r-project.org/bin/windows/base/} and press the link ``Download R\ldots{}''
\item
  Run the downloaded installer file and follow the installation wizard
\end{enumerate}

The wizard will install ``R'' into your \texttt{Program\ Files} folders and adds a shortcut in your Start menu. Note that you will need to have all necessary administration rights to install new software on your machine.

Mac OSX
1. Open \url{https://cran.r-project.org/bin/macosx/} and download the latest \texttt{*.pkg} file
1. Run the downloaded installer file and follow the installation wizard

The installer allows you to customize your installation. However the default values will be suitable for most users.

Liux
``R'' is part of many Linux distributions, therefore you should check with your Linux package management system if it's already installed.

The CRAN website provides files to build ``R'' from source on Debian, Redhat, SUSE, and Ubuntu systems under the link ``Download R for Linux''

\begin{itemize}
\tightlist
\item
  Open \url{https://cran.r-project.org/bin/linux/} and then follow the directory trail to the version of Linux you wish to install R on top of
\end{itemize}

The exact installation procedure will vary depending on your Linux operating system. CRAN supports the process by grouping each set of source files with documentation or README files that explain how to install on your system.

\hypertarget{download-and-install-rstudio}{%
\subsection{Download and Install RStudio}\label{download-and-install-rstudio}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Open \url{https://rstudio.com/products/rstudio/download/} and download ``RStudio Desktop Open Source''
\item
  Follow the on-screen instructions
\item
  Once you have installed ``R Studio'', you can run it like any other application by clicking the program icon
\end{enumerate}

\newpage

\hypertarget{installationPackages}{%
\section{Install required packages}\label{installationPackages}}

Appendix \ref{packages} gives you an introduction to what a package is and how to install it. Below are the packages used in this book and it is recommended to install them.

\begin{itemize}
\item
  Open ``RStudio'' just as you would any program, by clicking on its icon
\item
  Copy the following code and paste it into your console (on the bottom left, right of the symbol \texttt{\textgreater{}}):
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"devtools"}\NormalTok{, }\StringTok{"tidyverse"}\NormalTok{, }\StringTok{"plotly"}\NormalTok{, }\StringTok{"lubridate"}\NormalTok{, }\StringTok{"r2d3"}\NormalTok{)}
\KeywordTok{install_github}\NormalTok{(}\StringTok{"hslu-ige-laes/redutils"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  Press \texttt{Enter} or \texttt{Return}
\end{itemize}

The installation of the packages is now in progress and this may take a while, please be patient. In the meantime you can read in appendix \ref{packages} what packages are in general and how they can be installed and later loaded into scripts.

\newpage

\hypertarget{createFirstScript}{%
\section{Create your first R Script}\label{createFirstScript}}

Finally, you have installed ``R'' and ``RStudio'' with some packages on your computer. Good, hopefully everything worked fine up to now.

Let's create the first script with a visualization:

\begin{itemize}
\item
  Open ``RStudio'' just as you would any program, by clicking on its icon
\item
  Go to the menu on the top left and click to \texttt{File\ /\ New\ File\ /\ R\ Script}
\item
  Copy the following code and paste it into your script:
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(graphics)}
\KeywordTok{plot}\NormalTok{(co2, }\DataTypeTok{ylab =} \StringTok{"CO2 (ppm)"}\NormalTok{, }\DataTypeTok{las =} \DecValTok{1}\NormalTok{)}
\KeywordTok{title}\NormalTok{(}\DataTypeTok{main =} \StringTok{"Mauna Loa Atmospheric CO2 Concentration"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\item
  select all by pressing \texttt{Ctrl\ +\ A}
\item
  Thren run the code by pressing the \texttt{Run} Button or \texttt{Ctrl\ +\ Enter}
\end{itemize}

You should now get your first visualization:

\includegraphics{edar_files/figure-latex/co2 intro graph-1.pdf}

\begin{quote}
As you probably noticed, we did not load any data. The basic installation of ``R'' and some packages come with test data. So that is an easy way to test something. \href{https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/00Index.html}{The R Dataset Package} provides some preinstalled datasets, including the used ``Mauna Loa Atmospheric CO2 Concentration'' dataset.
\end{quote}

\hypertarget{part-r-basics}{%
\part{R Basics}\label{part-r-basics}}

\hypertarget{introduction-to-r-basics}{%
\chapter{Introduction to R Basics}\label{introduction-to-r-basics}}

The following chapters of the part ``R-Basics'' is a short overview of the fundamental principles for understanding the code presented in the recipes in part ``Data Visualizations''. It focuses on practical examples of how data can be loaded, transformed and analyzed.

It is not the goal of this book to fully introduce beginners to the programming language ``R'' and the environment in general. There are many really good sources where you can familiarize yourself with ``R'' if needed.

Two sources are recommended to facilitate the introduction to ``R'' and to learn the relevant basics. Choose one that suits you and go through the recommended chapter:

\begin{itemize}
\tightlist
\item
  \href{https://rafalab.github.io/dsbook/r-basics.html}{Introduction to Data Science - Chapter 2 ``R Basics''}
\item
  \href{https://smogdr.github.io/edar_coursebook/rprog1.html}{Engineering Data Analysis in R - Chapter 2 ``The R Programming Environment''}
\end{itemize}

Throughout the book, reference is made to these two continuative sources and you only need to read the one that appeals to you more. In the referenced chapters, these cover similar content.

\hypertarget{loading-data}{%
\chapter{Loading Data}\label{loading-data}}

This chapter introduces two functions that can be used to load data from csv-files and Excel-files.

Experienced readers will find more information about data imports here:

\begin{itemize}
\item
  \href{https://rafalab.github.io/dsbook/importing-data.html}{Introduction to Data Science - Chapter 5 ``Importing data''}
\item
  {[}Engineering Data Analysis in R - Chapter 3 ``Getting and Cleaning Data''{]})\url{https://smogdr.github.io/edar_coursebook/rprog2.html})\{target="\_blank"\}
\end{itemize}

csv-Files

Load data from comma separated files

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# read data from current folder}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"datafile.csv"}\NormalTok{)}

\CommentTok{# read data from a specific folder}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"C:/Desktop/datafile.csv"}\NormalTok{)}

\CommentTok{# read data from a file in the internet}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatElectricity.csv"}\NormalTok{)}

\CommentTok{# add arguments on how to parse the content}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"datafile.csv"}\NormalTok{,}
               \DataTypeTok{header=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{sep =}\StringTok{","}\NormalTok{,}
               \DataTypeTok{na.strings =} \KeywordTok{c}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"NA"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{quote}
Attention: By default, strings in the data are treated as factors, so add \texttt{stringsAsFactors=FALSE}
\end{quote}

\begin{quote}
Set your cursor to the function name \texttt{read.csv()} and press F1. Then you get in R Studio bottom right in the tab \texttt{Help} information about other function arguments you can use.
\end{quote}

\begin{quote}
Note that the function read.csv() has the default \texttt{sep\ =","} and read.csv2() has the default \texttt{sep\ =";"}
\end{quote}

Excel-Files

Load data from \texttt{*.xlsx} Excel files:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Only need to install once}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"xlsx"}\NormalTok{)}

\KeywordTok{library}\NormalTok{(xslx)}

\NormalTok{df <-}\StringTok{ }\KeywordTok{read.xlsx}\NormalTok{(}\StringTok{"datafile.xlsx"}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.xlsx}\NormalTok{(}\StringTok{"datafile.xlsx"}\NormalTok{, }\DataTypeTok{sheetIndex=}\DecValTok{2}\NormalTok{)}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.xlsx}\NormalTok{(}\StringTok{"datafile.xlsx"}\NormalTok{, }\DataTypeTok{sheetName=}\StringTok{"Revenues"}\NormalTok{)}

\CommentTok{# show the first lines of the so called "data frame"}
\KeywordTok{head}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

For reading older Excel files in the .xls format, the gdata package has the function read.xls():

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Only need to install once}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"gdata"}\NormalTok{)}

\KeywordTok{library}\NormalTok{(gdata)}

\NormalTok{df <-}\StringTok{ }\KeywordTok{read.xls}\NormalTok{(}\StringTok{"datafile.xls"}\NormalTok{) }\CommentTok{# Read first sheet}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.xls}\NormalTok{(}\StringTok{"datafile.xls"}\NormalTok{, }\DataTypeTok{sheet=}\DecValTok{2}\NormalTok{) }\CommentTok{# Read second sheet}
\end{Highlighting}
\end{Shaded}

\begin{quote}
Both the xlsx and gdata packages require other software to be installed on your computer. For xlsx, you need to install Java on your machine. For gdata, you need Perl, which comes as standard on Linux and Mac OS X, but not Windows. On Windows, you'll need ActiveState Perl. The Community Edition can be obtained for free.
\end{quote}

\hypertarget{data-wrangling}{%
\chapter{Data Wrangling}\label{data-wrangling}}

This chapter gives an overview of the most important data manipulation functions used throughout this book.

Experienced readers will find more information about data imports here:

\begin{itemize}
\item
  \href{https://rafalab.github.io/dsbook/tidyverse.html\#summarizing-data}{Introduction to Data Science - Chapter 4 ``The tidyverse''}
\item
  \href{https://smogdr.github.io/edar_coursebook/rprog2.html\#data-cleaning}{Engineering Data Analysis in R - Chapter 3.5 ``Data Cleaning''}
\item
  \href{https://smogdr.github.io/edar_coursebook/rprog2.html\#piping}{Engineering Data Analysis in R - Chapter 3.6 ``Piping''}
\end{itemize}

It is a fact that the data import and manipulation part of analyses often takes more time than the actual analysis or visualization itself. This is because the exchange data formats are not standardized and meters and sensors record at different time intervals. Data quality, missing data, data imputation and data cleansing also play a major role.

\newpage

\hypertarget{add-metadata-for-later-filtering}{%
\section{Add Metadata for later filtering}\label{add-metadata-for-later-filtering}}

Firstly we have to load a dataset into a dataframe:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# load data set}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/centralOutsideTemp.csv"}\NormalTok{,}
               \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{year-month-day-day-of-week}{%
\subsection{Year, Month, Day, Day of Week}\label{year-month-day-day-of-week}}

To e.g.~group, filter and aggregate data we need eventually the date splitted up in day, month and year:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}

\NormalTok{df}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\StringTok{"YmdHMS"}\NormalTok{, }\DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{year <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"year"}\NormalTok{))}
\NormalTok{df}\OperatorTok{$}\NormalTok{month <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"month"}\NormalTok{))}
\NormalTok{df}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"day"}\NormalTok{))}
\NormalTok{df}\OperatorTok{$}\NormalTok{weekday <-}\StringTok{ }\KeywordTok{wday}\NormalTok{(df}\OperatorTok{$}\NormalTok{time,}
                   \DataTypeTok{label =} \OtherTok{TRUE}\NormalTok{,}
                   \DataTypeTok{locale =} \StringTok{"English"}\NormalTok{,}
                   \DataTypeTok{abbr =} \OtherTok{TRUE}\NormalTok{,}
                   \DataTypeTok{week_start =} \KeywordTok{getOption}\NormalTok{(}\StringTok{"lubridate.week.start"}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

This code first parses the timestamp with a specific timezone. Then three columns are added.

Please note that the month also contains the year and a day. This is useful for a later step where you can group the series afterwards.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{head}\NormalTok{(df,}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time centralOutsideTemp
## 1 2018-03-21 11:00:00                5.2
## 2 2018-03-21 12:00:00                6.7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{tail}\NormalTok{(df,}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                      time centralOutsideTemp
## 21864 2020-09-17 10:00:00              26.65
## 21865 2020-09-17 11:00:00              28.10
\end{verbatim}

\hypertarget{season-of-year}{%
\subsection{Season of Year}\label{season-of-year}}

For some analyses it is useful to color single points of a scatterplot according to the season. For this we need to have the season in a separate column:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\CommentTok{# get season from a date}
\KeywordTok{getSeason}\NormalTok{(}\KeywordTok{as.Date}\NormalTok{(}\StringTok{"2019-04-01"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Spring"
\end{verbatim}

If you want to change the language, you can give the function dedicated names for the season:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{getSeason}\NormalTok{(}\KeywordTok{as.Date}\NormalTok{(}\StringTok{"2019-04-01"}\NormalTok{),}
                  \DataTypeTok{seasonlab =} \KeywordTok{c}\NormalTok{(}\StringTok{"Winter"}\NormalTok{,}\StringTok{"Frühling","}\NormalTok{Sommer}\StringTok{","}\NormalTok{Herbst}\StringTok{"))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Frühling"
\end{verbatim}

To apply this function to a whole dataframe we can use the dplyr mutate function. The code below creates a new column named ``season'':

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df <-}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{season =} \KeywordTok{getSeason}\NormalTok{(df}\OperatorTok{$}\NormalTok{time))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{head}\NormalTok{(df,}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time centralOutsideTemp season
## 1 2018-03-21 11:00:00                5.2 Spring
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{tail}\NormalTok{(df,}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                      time centralOutsideTemp season
## 21865 2020-09-17 11:00:00               28.1   Fall
\end{verbatim}

\newpage

\hypertarget{manipulating-data-frames}{%
\section{Manipulating Data Frames}\label{manipulating-data-frames}}

The \texttt{dplyr} package from the \texttt{tidyverse} introduces functions that perform some of the most common operations when working with data frames and uses names for these functions that are relatively easy to remember.

\hypertarget{change-row-names}{%
\subsection{Change Row Names}\label{change-row-names}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# rename columns}
\KeywordTok{names}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{,}\StringTok{"humidity"}\NormalTok{,}\StringTok{"temp_c"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{adding-a-column-with-mutate}{%
\subsection{\texorpdfstring{Adding a column with \texttt{mutate()}}{Adding a column with mutate()}}\label{adding-a-column-with-mutate}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}

\CommentTok{# add new column with temperature conversion from celsius to fahrenheit}
\NormalTok{df <-}\StringTok{ }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{temp_f =}\NormalTok{ temp_c }\OperatorTok{*}\StringTok{ }\FloatTok{1.8} \OperatorTok{+}\StringTok{ }\DecValTok{32}\NormalTok{)}

\CommentTok{# This code does the same, but only with a pipe}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{temp_f =}\NormalTok{ temp_c }\OperatorTok{*}\StringTok{ }\FloatTok{1.8} \OperatorTok{+}\StringTok{ }\DecValTok{32}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{subsetting-with-filter}{%
\subsection{\texorpdfstring{Subsetting with \texttt{filter()}}{Subsetting with filter()}}\label{subsetting-with-filter}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}

\CommentTok{# add new column with temperature conversion from celsius to fahrenheit}
\NormalTok{df <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(df,}
\NormalTok{             timestamp }\OperatorTok{>=}\StringTok{ "2020-01-01 00:00:00"}\NormalTok{,}
\NormalTok{             timestamp }\OperatorTok{<=}\StringTok{ "2020-12-31 23:45:00"}\NormalTok{)}

\NormalTok{df.high <-}\StringTok{ }\KeywordTok{filter}\NormalTok{(df, temp_c }\OperatorTok{>}\StringTok{ }\DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{quote}
Note: Whether you put the whole code on one line or split it after a comma does not have an effect on the computation, it is only more readable when the lines aren't too wide.
\end{quote}

\hypertarget{addremove-columns-with-select}{%
\subsection{\texorpdfstring{Add/remove columns with \texttt{select()}}{Add/remove columns with select()}}\label{addremove-columns-with-select}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}

\CommentTok{# Based on the upper example we remove the celsius column after calculation}
\NormalTok{df <-}\StringTok{ }\KeywordTok{select}\NormalTok{(df, }\OperatorTok{-}\NormalTok{temp_c)}

\CommentTok{# Create new data frame}
\NormalTok{df.new <-}\StringTok{ }\KeywordTok{select}\NormalTok{(df, timestamp, temp_f)}

\CommentTok{# use select() in a so called dplyr pipe}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{temp_f =}\NormalTok{ temp_c }\OperatorTok{*}\StringTok{ }\FloatTok{1.8} \OperatorTok{+}\StringTok{ }\DecValTok{32}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{temp_c)}
\end{Highlighting}
\end{Shaded}

\hypertarget{the-pipe}{%
\subsection{\texorpdfstring{The pipe \texttt{\%\textgreater{}\%}}{The pipe \%\textgreater\%}}\label{the-pipe}}

With the package \texttt{dplyr} we can perform a series of operations, for example select and then filter, by sending the results of one function to another using what is called the pipe operator: \texttt{\%\textgreater{}\%}.

Details can be found in \href{https://rafalab.github.io/dsbook/tidyverse.html}{Introduction to Data Science - Chapter 4.5}

\hypertarget{wide-to-long}{%
\subsection{Wide to Long}\label{wide-to-long}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyr)}

\CommentTok{# load test data set}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatTempHum.csv"}\NormalTok{,}
               \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\CommentTok{# create a copy of the dataframe and print the header and the first five line}
\KeywordTok{head}\NormalTok{(df, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time FlatA_Hum FlatA_Temp FlatB_Hum FlatB_Temp FlatC_Hum
## 1 2018-10-03 00:00:00      53.0      24.43      38.8      22.40      44.0
## 2 2018-10-03 01:00:00      53.0      24.40      38.8      22.40      44.0
## 3 2018-10-03 02:00:00      53.0      24.40      39.3      22.40      44.7
## 4 2018-10-03 03:00:00      53.0      24.40      40.3      22.40      45.0
## 5 2018-10-03 04:00:00      53.3      24.40      41.0      22.37      45.2
##   FlatC_Temp FlatD_Hum FlatD_Temp
## 1       24.5      49.0      24.43
## 2       24.5      49.0      24.40
## 3       24.5      48.3      24.38
## 4       24.5      48.0      24.33
## 5       24.5      47.7      24.30
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# convert wide to long format}
\NormalTok{df.long <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(tidyr}\OperatorTok{::}\KeywordTok{pivot_longer}\NormalTok{(df,}
                                             \DataTypeTok{cols =} \OperatorTok{-}\NormalTok{time,}
                                             \DataTypeTok{names_to =} \StringTok{"sensor"}\NormalTok{,}
                                             \DataTypeTok{values_to =} \StringTok{"value"}\NormalTok{,}
                                             \DataTypeTok{values_drop_na =} \OtherTok{TRUE}\NormalTok{))}

\CommentTok{# long format}
\KeywordTok{head}\NormalTok{(df.long, }\DecValTok{16}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                   time     sensor value
## 1  2018-10-03 00:00:00  FlatA_Hum 53.00
## 2  2018-10-03 00:00:00 FlatA_Temp 24.43
## 3  2018-10-03 00:00:00  FlatB_Hum 38.80
## 4  2018-10-03 00:00:00 FlatB_Temp 22.40
## 5  2018-10-03 00:00:00  FlatC_Hum 44.00
## 6  2018-10-03 00:00:00 FlatC_Temp 24.50
## 7  2018-10-03 00:00:00  FlatD_Hum 49.00
## 8  2018-10-03 00:00:00 FlatD_Temp 24.43
## 9  2018-10-03 01:00:00  FlatA_Hum 53.00
## 10 2018-10-03 01:00:00 FlatA_Temp 24.40
## 11 2018-10-03 01:00:00  FlatB_Hum 38.80
## 12 2018-10-03 01:00:00 FlatB_Temp 22.40
## 13 2018-10-03 01:00:00  FlatC_Hum 44.00
## 14 2018-10-03 01:00:00 FlatC_Temp 24.50
## 15 2018-10-03 01:00:00  FlatD_Hum 49.00
## 16 2018-10-03 01:00:00 FlatD_Temp 24.40
\end{verbatim}

\hypertarget{long-to-wide}{%
\subsection{Long to Wide}\label{long-to-wide}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# long format}
\KeywordTok{head}\NormalTok{(df.long)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time     sensor value
## 1 2018-10-03 00:00:00  FlatA_Hum 53.00
## 2 2018-10-03 00:00:00 FlatA_Temp 24.43
## 3 2018-10-03 00:00:00  FlatB_Hum 38.80
## 4 2018-10-03 00:00:00 FlatB_Temp 22.40
## 5 2018-10-03 00:00:00  FlatC_Hum 44.00
## 6 2018-10-03 00:00:00 FlatC_Temp 24.50
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# convert long table into wide table}
\NormalTok{df.wide <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(tidyr}\OperatorTok{::}\KeywordTok{pivot_wider}\NormalTok{(df.long,}
                                            \DataTypeTok{names_from =} \StringTok{"sensor"}\NormalTok{,}
                                            \DataTypeTok{values_from =} \StringTok{"value"}\NormalTok{)}
\NormalTok{                         )}

\CommentTok{# wide format}
\KeywordTok{head}\NormalTok{(df.wide)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time FlatA_Hum FlatA_Temp FlatB_Hum FlatB_Temp FlatC_Hum
## 1 2018-10-03 00:00:00      53.0      24.43      38.8      22.40      44.0
## 2 2018-10-03 01:00:00      53.0      24.40      38.8      22.40      44.0
## 3 2018-10-03 02:00:00      53.0      24.40      39.3      22.40      44.7
## 4 2018-10-03 03:00:00      53.0      24.40      40.3      22.40      45.0
## 5 2018-10-03 04:00:00      53.3      24.40      41.0      22.37      45.2
## 6 2018-10-03 05:00:00      53.7      24.40      41.2      22.30      47.2
##   FlatC_Temp FlatD_Hum FlatD_Temp
## 1      24.50      49.0      24.43
## 2      24.50      49.0      24.40
## 3      24.50      48.3      24.38
## 4      24.50      48.0      24.33
## 5      24.50      47.7      24.30
## 6      24.57      47.2      24.30
\end{verbatim}

\hypertarget{DATAWRANGLING-MERGE-TWO-DATAFRAMES}{%
\subsection{Merge two Dataframes}\label{DATAWRANGLING-MERGE-TWO-DATAFRAMES}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# read file one and parse dates}
\NormalTok{dfOutsideTemp <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/centralOutsideTemp.csv"}\NormalTok{,}
                          \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                          \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfOutsideTemp}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfOutsideTemp}\OperatorTok{$}\NormalTok{time,}
                                      \DataTypeTok{orders =} \StringTok{"YmdHMS"}\NormalTok{,}
                                      \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\CommentTok{# read file two and parse dates}
\NormalTok{dfFlatTempHum <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatTempHum.csv"}\NormalTok{,}
                          \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfFlatTempHum}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfFlatTempHum}\OperatorTok{$}\NormalTok{time,}
                                      \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                                      \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\CommentTok{# merge the two files into a new data frame and keep only rows where all values are available}
\NormalTok{df <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(dfOutsideTemp, dfFlatTempHum, }\DataTypeTok{by =} \StringTok{"time"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\KeywordTok{head}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time centralOutsideTemp FlatA_Hum FlatA_Temp FlatB_Hum
## 1 2018-10-03 00:00:00              11.80      53.0      24.43      38.8
## 2 2018-10-03 01:00:00              11.25      53.0      24.40      38.8
## 3 2018-10-03 02:00:00              11.45      53.0      24.40      39.3
## 4 2018-10-03 03:00:00              11.40      53.0      24.40      40.3
## 5 2018-10-03 04:00:00              11.10      53.3      24.40      41.0
## 6 2018-10-03 05:00:00              11.05      53.7      24.40      41.2
##   FlatB_Temp FlatC_Hum FlatC_Temp FlatD_Hum FlatD_Temp
## 1      22.40      44.0      24.50      49.0      24.43
## 2      22.40      44.0      24.50      49.0      24.40
## 3      22.40      44.7      24.50      48.3      24.38
## 4      22.40      45.0      24.50      48.0      24.33
## 5      22.37      45.2      24.50      47.7      24.30
## 6      22.30      47.2      24.57      47.2      24.30
\end{verbatim}

\hypertarget{explorative-data-analysis}{%
\chapter{Explorative Data Analysis}\label{explorative-data-analysis}}

Explorative Data Analysis (EDA) is a technique based on the human characteristic of visual pattern recognition. The purpose of EDA is simple: to learn more about data by visualizing it in different ways. John W. Tukey, considered the founder of exploratory data analysis, once wrote:

\begin{quote}
``Exploratory data analysis is graphical detective work.'' - John W. Tukey
\end{quote}

\hypertarget{get-overview-of-data}{%
\section{Get Overview of Data}\label{get-overview-of-data}}

A first step is getting an overview of the whole data set and specific series of it.

\hypertarget{load-data}{%
\subsection{Load data}\label{load-data}}

Load test data set in a data frame (e.g.~from a csv-file)

\begin{verbatim}
## Warning: 3 failed to parse.
\end{verbatim}

\hypertarget{names}{%
\subsection{Names}\label{names}}

Show the column headers of a data frame

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{names}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "time"               "energyHeatingMeter" "supplyTempHeating"
\end{verbatim}

\hypertarget{structure}{%
\subsection{Structure}\label{structure}}

Show the structure of the data frame

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{str}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 'data.frame':    22317 obs. of  3 variables:
##  $ time              : POSIXct, format: "2018-03-03 00:00:00" "2018-03-03 01:00:00" ...
##  $ energyHeatingMeter: num  45020 NA NA NA NA ...
##  $ supplyTempHeating : num  24.7 24.1 23.7 23.4 31.6 ...
\end{verbatim}

\hypertarget{headtail}{%
\subsection{Head/Tail}\label{headtail}}

Show the first and last values

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{head}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  time energyHeatingMeter supplyTempHeating
## 1 2018-03-03 00:00:00           45019.81             24.73
## 2 2018-03-03 01:00:00                 NA             24.06
## 3 2018-03-03 02:00:00                 NA             23.73
## 4 2018-03-03 03:00:00                 NA             23.45
## 5 2018-03-03 04:00:00                 NA             31.59
## 6 2018-03-03 05:00:00                 NA             29.14
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{tail}\NormalTok{(df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                      time energyHeatingMeter supplyTempHeating
## 22312 2020-09-17 15:00:00                 NA                NA
## 22313 2020-09-17 16:00:00                 NA                NA
## 22314 2020-09-17 17:00:00                 NA                NA
## 22315 2020-09-17 18:00:00                 NA                NA
## 22316 2020-09-17 19:00:00                 NA                NA
## 22317 2020-09-17 20:00:00                 NA                NA
\end{verbatim}

\begin{quote}
Note: if you want to show only the first three entries, you can type \texttt{head(df,3)}
\end{quote}

\hypertarget{five-number-summary}{%
\subsection{Five number summary}\label{five-number-summary}}

Reveals details like object classes

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{summary}\NormalTok{(df}\OperatorTok{$}\NormalTok{supplyTempHeating)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   18.37   23.35   24.61   25.72   27.49   44.68     362
\end{verbatim}

\hypertarget{quickly-exploring-data}{%
\section{Quickly Exploring Data}\label{quickly-exploring-data}}

Please refer to the \href{https://r-graphics.org/chapter-quick}{R Graphics Cookbook from Winston Chang - Chapter 2 ``Quickly Exploring Data''}.

This is a great resource where you can find everything you need to know about creating basic plots.

\hypertarget{part-data-visualizations}{%
\part{Data Visualizations}\label{part-data-visualizations}}

\hypertarget{seasonal-plots}{%
\chapter{Seasonal Plots}\label{seasonal-plots}}

Seasonal plots are a graphical tool to visualize and detect seasonality in a time series. Based on a selected periodicity it emphasizes the seasonal patterns and also shows the changes in seasonality over time. Especially, it allows to detect changes between different seasons.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotSeasonalXY} \caption{Seasonal Plot Overlapping per Month over 10 Years}\label{fig:unnamed-chunk-8}
\end{figure}

However, such plots are only useful if the period of the seasonality is already known. In many cases, this will in fact be known. For example, monthly data typically has a period of 12. If the period is not known, an autocorrelation plot or spectral plot can be used to determine it.

This chapter shows some useful types of seasonal plots.

\hypertarget{overlapping}{%
\section{Overlapping}\label{overlapping}}

\hypertarget{goal}{%
\subsection{Goal}\label{goal}}

Plot a seasonal plot as described in \href{https://otexts.com/fpp2/seasonal-plots.html}{Hyndman and Athanasopoulos (2014, chapter 2.4)}:

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotSeasonalXY} \caption{Seasonal Plot Overlapping per Month over 10 Years}\label{fig:unnamed-chunk-9}
\end{figure}

This is like a standard time series plot except that the data are plotted against the ``seasons'' for each year and are overlapping. Be aware that seasons in this context don't correlate with the seasons of the year.

\hypertarget{data-basis}{%
\subsection{Data Basis}\label{data-basis}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/seasonalPlotXY0-1.pdf}
\caption{\label{fig:seasonalPlotXY0}Raw Data for Seasonal Plot Overlapping}
\end{figure}

\hypertarget{solution}{%
\subsection{Solution}\label{solution}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(forecast)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\KeywordTok{library}\NormalTok{(ggthemes)}
\KeywordTok{library}\NormalTok{(viridis)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# load csv file}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatHeatAndHotWater.csv"}\NormalTok{,}
                \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# filter flat}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(timestamp, Adr02_energyHeat)}

\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\CommentTok{# calculate consumption value per month}
\CommentTok{# pay attention, the value of 2010-02-01 00:00:00 represents the meter reading on february first,}
\CommentTok{# so the consumption for february first is value(march) - value(february)!}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{lead}\NormalTok{(meterValue) }\OperatorTok{-}\StringTok{ }\NormalTok{meterValue)}

\CommentTok{# remove counter value column}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue)}

\CommentTok{# value correction (outlier because of commissioning)}
\NormalTok{df[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{600}

\CommentTok{# create time series object for ggseanplot function}
\NormalTok{df.ts <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(value) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(), }\DataTypeTok{frequency =} \DecValTok{12}\NormalTok{, }\DataTypeTok{start =} \KeywordTok{min}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)))}

\CommentTok{# create x/y plot}
\NormalTok{numYears =}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp))) }\CommentTok{# used for colours}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggseasonplot}\NormalTok{(df.ts,}
                     \DataTypeTok{col =} \KeywordTok{viridis}\NormalTok{(numYears),}
                     \DataTypeTok{main =} \StringTok{"Seasonal Plot x/y per Month over 10 years"}\NormalTok{,}
                     \DataTypeTok{ylab =} \StringTok{"Energy Consumption (kWh/month)"}
\NormalTok{                     )}

\CommentTok{# show static plot (uncomment it if you want a static plot)}
\CommentTok{#plot}

\CommentTok{# change theme (optional)}
\NormalTok{plot <-}\StringTok{ }\NormalTok{plot }\OperatorTok{+}\StringTok{ }\NormalTok{ggthemes}\OperatorTok{::}\KeywordTok{theme_economist}\NormalTok{()}

\CommentTok{# make plot interactive (optional)}
\NormalTok{plotly <-}\StringTok{ }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{ggplotly}\NormalTok{(plot)}

\CommentTok{# show plot interactive plot (optional)}
\NormalTok{plotly}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/seasonalPlotXY1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotSeasonalXY.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save interactive plot as html (optional)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\NormalTok{htmlwidgets}\OperatorTok{::}\KeywordTok{saveWidget}\NormalTok{(plotly, }\StringTok{"plotlySeasonalXY.html"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion}{%
\subsection{Discussion}\label{discussion}}

A seasonal plot allows the underlying seasonal pattern to be seen more clearly, and is especially useful in identifying years in which the pattern changes.

Hints:

\begin{itemize}
\item
  in the interactive version you can double-click on year in the legend, then only this year is visible
\item
  click once to activate/deactivate a year
\end{itemize}

\newpage

\hypertarget{mini-plots}{%
\section{Mini Plots}\label{mini-plots}}

\hypertarget{goal-1}{%
\subsection{Goal}\label{goal-1}}

Plot a seasonal month plot as described in \href{https://otexts.com/fpp2/seasonal-subseries-plots.html}{Hyndman and Athanasopoulos (2014, chapter 2.5)}:

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotSeasonalMiniplots} \caption{Seasonal Plot with mini Time Plots over 10 Years}\label{fig:unnamed-chunk-10}
\end{figure}

Here the seasonal patterns for each season are collected together in seprate mini time plots. Be aware that seasons in this context don't correlate with the seasons of the year.

\hypertarget{data-basis-1}{%
\subsection{Data Basis}\label{data-basis-1}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/seasonalMiniplots0-1.pdf}
\caption{\label{fig:seasonalMiniplots0}Raw Data for Seasonal Miniplots}
\end{figure}

\hypertarget{solution-1}{%
\subsection{Solution}\label{solution-1}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(forecast)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\KeywordTok{library}\NormalTok{(ggthemes)}
\KeywordTok{library}\NormalTok{(viridis)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# load csv file}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatHeatAndHotWater.csv"}\NormalTok{,}
                \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# filter flat}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(timestamp, Adr02_energyHeat)}

\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\CommentTok{# calculate consumption value per month}
\CommentTok{# pay attention, the value of 2010-02-01 00:00:00 represents the meter reading on february first,}
\CommentTok{# so the consumption for february first is value(march) - value(february)!}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{lead}\NormalTok{(meterValue) }\OperatorTok{-}\StringTok{ }\NormalTok{meterValue)}

\CommentTok{# remove counter value column}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue)}

\CommentTok{# value correction (outlier because of commissioning)}
\NormalTok{df[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{600}

\CommentTok{# create time series object for ggmonthplot function}
\NormalTok{df.ts <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(df[}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\DataTypeTok{frequency =} \DecValTok{12}\NormalTok{, }\DataTypeTok{start =} \KeywordTok{min}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)))}

\CommentTok{# create x/y plot}

\NormalTok{numYears =}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)))}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggmonthplot}\NormalTok{(df.ts,}
                    \DataTypeTok{col =} \KeywordTok{viridis}\NormalTok{(numYears),}
                    \DataTypeTok{main =} \StringTok{"Seasonal Miniplots over 10 years}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
                    \DataTypeTok{ylab =} \StringTok{"Energy Consumption (kWh/month)}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
                    \DataTypeTok{xlab =} \StringTok{"Month}\CharTok{\textbackslash{}n}\StringTok{ "}
\NormalTok{                    )}

\CommentTok{# change theme (optional)}
\NormalTok{plot <-}\StringTok{ }\NormalTok{plot }\OperatorTok{+}\StringTok{ }\NormalTok{ggthemes}\OperatorTok{::}\KeywordTok{theme_economist}\NormalTok{()}

\CommentTok{# make plot interactive (optional)}
\NormalTok{plotly <-}\StringTok{ }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{ggplotly}\NormalTok{(plot)}

\CommentTok{# show plot}
\NormalTok{plotly}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/seasonalMiniplots1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotSeasonalMiniplots.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save interactive plot as html}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\NormalTok{htmlwidgets}\OperatorTok{::}\KeywordTok{saveWidget}\NormalTok{(plotly, }\StringTok{"plotlySeasonalMiniplots.html"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-1}{%
\subsection{Discussion}\label{discussion-1}}

\begin{itemize}
\item
  This type of seasonal plot shows the mean value of each month and therefore emphasises on the monthly comparison
\item
  It revelas as well the mean seasonla pattern with the blue lines
\end{itemize}

\newpage

\hypertarget{polar}{%
\section{Polar}\label{polar}}

\hypertarget{goal-2}{%
\subsection{Goal}\label{goal-2}}

Plot a seasonal plot as described in \href{https://otexts.com/fpp2/seasonal-plots.html}{Hyndman and Athanasopoulos (2014, chapter 2.4)}:

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotSeasonalPolar} \caption{Seasonal Plot Polar per Month over 10 Years}\label{fig:unnamed-chunk-11}
\end{figure}

This is like an overlapping time series plot which uses polar coordinates. Be aware that seasons in this context don't correlate with the seasons of the year.

\hypertarget{data-basis-2}{%
\subsection{Data Basis}\label{data-basis-2}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/seasonalPlotPolar00-1.pdf}
\caption{\label{fig:seasonalPlotPolar00}Raw Data for Seasonal Plot Polar}
\end{figure}

\hypertarget{solution-2}{%
\subsection{Solution}\label{solution-2}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(forecast)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\KeywordTok{library}\NormalTok{(ggthemes)}
\KeywordTok{library}\NormalTok{(viridis)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# load csv file}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatHeatAndHotWater.csv"}\NormalTok{,}
                \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# filter flat}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(timestamp, Adr02_energyHeat)}

\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\CommentTok{# calculate consumption value per month}
\CommentTok{# pay attention, the value of 2010-02-01 00:00:00 represents the meter reading on february first,}
\CommentTok{# so the consumption for february first is value(march) - value(february)!}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{lead}\NormalTok{(meterValue) }\OperatorTok{-}\StringTok{ }\NormalTok{meterValue)}

\CommentTok{# remove counter value column}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue)}

\CommentTok{# value correction (outlier because of commissioning)}
\NormalTok{df[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{600}

\NormalTok{df.ts <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(value) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(), }\DataTypeTok{frequency =} \DecValTok{12}\NormalTok{, }\DataTypeTok{start =} \KeywordTok{min}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)))}

\CommentTok{# create polar plot}

\NormalTok{numYears =}\StringTok{ }\KeywordTok{length}\NormalTok{(}\KeywordTok{unique}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)))}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggseasonplot}\NormalTok{(df.ts,}
                     \DataTypeTok{col =} \KeywordTok{viridis}\NormalTok{(numYears),}
                     \DataTypeTok{main =} \StringTok{"Seasonal Plot Polar per Month over 10 Years}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
                     \DataTypeTok{ylab =} \StringTok{"Energy Consumption (kWh/month)"}\NormalTok{,}
                     \DataTypeTok{polar =} \OtherTok{TRUE}
\NormalTok{                     )}

\CommentTok{# show plot (interactive version with plotly unfortunately not possible)}
\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/seasonalPlotPolar1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotSeasonalPolar.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-2}{%
\subsection{Discussion}\label{discussion-2}}

This representation emphasizes the high consumption in summer very well, which could undoubtedly be reduced in a residential building. The Years 2018 and 2019 show, that this optimization was done.

To emphasize this optimization please refer to the next chapter \ref{dataVisSeasonalBefAft}.

\newpage

\hypertarget{dataVisSeasonalBefAft}{%
\section{Before/After Optimization}\label{dataVisSeasonalBefAft}}

\hypertarget{goal-3}{%
\subsection{Goal}\label{goal-3}}

To highlight an energy optimization in a season diagram, we can gray out the seasons before the optimization and only highlight the monthly values after the optimization. To better quantify the success, we can calculate and display the confidence interval of the years before.

In the following we will create the following plot:

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotEnergyConsBeforeAfter} \caption{Seasonal Plot Overlapping Before/After}\label{fig:unnamed-chunk-12}
\end{figure}

\hypertarget{data-basis-3}{%
\subsection{Data Basis}\label{data-basis-3}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/energyConsBeforeAfter0-1.pdf}
\caption{\label{fig:energyConsBeforeAfter0}Raw Data for Seasonal Plot Overlapping Before/After Optimization}
\end{figure}

\hypertarget{solution-3}{%
\subsection{Solution}\label{solution-3}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\KeywordTok{library}\NormalTok{(ggthemes)}

\CommentTok{# load csv file}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatHeatAndHotWater.csv"}\NormalTok{,}
                \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# filter flat}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(timestamp, Adr02_energyHeat)}

\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\CommentTok{# calculate consumption value per month}
\CommentTok{# pay attention, the value of 2010-02-01 00:00:00 represents the meter reading on february first,}
\CommentTok{# so the consumption for february first is value(march) - value(february)!}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{lead}\NormalTok{(meterValue) }\OperatorTok{-}\StringTok{ }\NormalTok{meterValue)}

\CommentTok{# remove counter value column}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue)}

\CommentTok{# value correction (outlier because of commissioning)}
\NormalTok{df[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{600}

\CommentTok{# create plot}
\NormalTok{plot <-}\StringTok{ }\KeywordTok{plotSeasonalXYBeforeAfter}\NormalTok{(df,}
                                  \DataTypeTok{dateOptimization =} \StringTok{"2017-09-01"}\NormalTok{,}
                                  \DataTypeTok{locTimeZone =} \StringTok{"Europe/Zurich"}\NormalTok{,}
                                  \DataTypeTok{main =} \StringTok{"Before/After Optimization"}\NormalTok{,}
                                  \DataTypeTok{ylab =} \StringTok{"Energy Consumption }\CharTok{\textbackslash{}n}\StringTok{(kWh/month)"}
\NormalTok{                                  )}

\CommentTok{# change theme (optional)}
\NormalTok{plot <-}\StringTok{ }\NormalTok{plot }\OperatorTok{+}\StringTok{ }\NormalTok{ggthemes}\OperatorTok{::}\KeywordTok{theme_economist}\NormalTok{()}

\CommentTok{# make plot interactive (optional)}
\NormalTok{plotly <-}\StringTok{ }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{ggplotly}\NormalTok{(plot)}

\CommentTok{# show plot}
\NormalTok{plotly}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/energyConsBeforeAfter1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotSeasonalXYBeforeAfter.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save interactive plot as html (optional)}
\KeywordTok{library}\NormalTok{(htmlwidgets)}
\NormalTok{htmlwidgets}\OperatorTok{::}\KeywordTok{saveWidget}\NormalTok{(plotly, }\StringTok{"plotlySeasonalXYBeforeAfter.html"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-3}{%
\subsection{Discussion}\label{discussion-3}}

\begin{itemize}
\item
  One can clearly see the impact of the optimization in mid-2017
\item
  And as well the too low setting of January 2018 where the thermostat of the flat got deactivated
\item
  The confidence band shows as well the year 2013 which had an unusual high consumption from February to June
\end{itemize}

\hypertarget{time-series-decomposition}{%
\chapter{Time Series Decomposition}\label{time-series-decomposition}}

Typical time series result from the interaction of regular and random causes. The regular causes can vary periodically (seasonally) and/or contain long-term trends. Random influences are often called noise.

Decomposition deconstructs time series into its components ``trend'', ``seasonality'' and ``randomness.'' For further data analysis it is often necessary to decompose the trend and the seasonal component from the raw data. Therefore, a large part of the time series analyses deals with corresponding procedures. Sometimes the remaining Randomness is of interest and sometimes a detrended series as in chapter \ref{dailyProfilesDecomposed}.

Trend Component
The trend component of a time series refers to the general direction in which the time series is moving in the long term. Time series can have a positive or a negative trend, but can also have no trend.
A trend exists when there is a persistent increasing and/or decreasing direction in the data.

Seasonal Component
The seasonal component for time series data refers to its tendency to rise and fall at consistent frequencies. Seasonality occurs over a fixed and known period (e.g., the quarter of the year, the month, or day of the week).

Random/Remainder/Irregular Component
The remainder is what's left of the time series data after removing its trend and seasonal components. It is the random fluctuation in the time series data that the above components cannot explain.

An exemplary decomposition of an outside temperature time series over 7 days:
\includegraphics{edar_files/figure-latex/decompositionTOa-1.pdf}

This chapter shows how a time series can be decomposed and presented interactively.

\newpage

\hypertarget{long-term}{%
\section{Long term}\label{long-term}}

\hypertarget{goal-4}{%
\subsection{Goal}\label{goal-4}}

Decompose a long term time series of ten years monthly data.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDecompositionLong} \caption{Decomposition of long time series over 10 Years}\label{fig:unnamed-chunk-13}
\end{figure}

\hypertarget{data-basis-4}{%
\subsection{Data Basis}\label{data-basis-4}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDecompositionLong0-1.pdf}
\caption{\label{fig:dataVisDecompositionLong0}Raw Data for Decomposition Plot Long Term}
\end{figure}

\hypertarget{solution-4}{%
\subsection{Solution}\label{solution-4}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(forecast)}

\CommentTok{# load csv file}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv2}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatHeatAndHotWater.csv"}\NormalTok{,}
                \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{)}

\CommentTok{# filter flat}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(timestamp, Adr02_energyHeat)}

\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Time"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\NormalTok{df}\OperatorTok{$}\NormalTok{Time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(df}\OperatorTok{$}\NormalTok{Time,}
                                \DataTypeTok{orders =} \StringTok{"YmdHMS"}\NormalTok{,}
                                \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\CommentTok{# calculate consumption value per month}
\CommentTok{# pay attention, the value of 2010-02-01 00:00:00 represents the meter reading on february first,}
\CommentTok{# so the consumption for february first is value(march) - value(february)!}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{lead}\NormalTok{(meterValue) }\OperatorTok{-}\StringTok{ }\NormalTok{meterValue)}

\CommentTok{# remove counter value column}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}
\NormalTok{df[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{] <-}\StringTok{ }\DecValTok{600}

\NormalTok{df.ts <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(value) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(), }\DataTypeTok{frequency =} \DecValTok{12}\NormalTok{, }\DataTypeTok{start =} \KeywordTok{min}\NormalTok{(}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{Time)))}

\NormalTok{df.decompose <-}\StringTok{ }\NormalTok{df.ts[,}\DecValTok{1}\NormalTok{] }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{stl}\NormalTok{(}\DataTypeTok{s.window =} \DecValTok{7}\NormalTok{)}

\NormalTok{df.decompose <-}\StringTok{ }\NormalTok{df.decompose}\OperatorTok{$}\NormalTok{time.series}

\NormalTok{df.decompose <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(df.decompose)}

\NormalTok{df.decompose <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(df, df.decompose)}

\NormalTok{data <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(tidyr}\OperatorTok{::}\KeywordTok{pivot_longer}\NormalTok{(df.decompose,}
                                          \DataTypeTok{cols =} \OperatorTok{-}\NormalTok{Time,}
                                          \DataTypeTok{names_to =} \StringTok{"Component"}\NormalTok{,}
                                          \DataTypeTok{values_to =} \StringTok{"Value"}\NormalTok{,}
                                          \DataTypeTok{values_drop_na =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{)}
\NormalTok{data}\OperatorTok{$}\NormalTok{component <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{Component)}
\NormalTok{data}\OperatorTok{$}\NormalTok{component <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{Component, }\KeywordTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}
                                           \StringTok{"trend"}\NormalTok{,}
                                           \StringTok{"seasonal"}\NormalTok{,}
                                           \StringTok{"remainder"}\NormalTok{))}
\NormalTok{data}\OperatorTok{$}\NormalTok{Value <-}\StringTok{ }\KeywordTok{round}\NormalTok{(data}\OperatorTok{$}\NormalTok{Value, }\DataTypeTok{digits =} \DecValTok{1}\NormalTok{)}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(data) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_path}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ Time,}
                \DataTypeTok{y =}\NormalTok{ Value}
\NormalTok{  ),}
  \DataTypeTok{color =} \StringTok{"black"}\NormalTok{,}
  \DataTypeTok{alpha =} \FloatTok{0.7}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{component, }\DataTypeTok{ncol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{scales =} \StringTok{"free_y"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_x_datetime}\NormalTok{(}\DataTypeTok{date_breaks =} \StringTok{"years"}\NormalTok{ , }\DataTypeTok{date_labels =} \StringTok{"%Y"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_minimal}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{panel.spacing =} \KeywordTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"lines"}\NormalTok{),}
        \DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \StringTok{""}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Time Series Decomposition over 10 Years"}\NormalTok{)}

\KeywordTok{ggplotly}\NormalTok{(plot)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDecompositionLong1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotDecompositionLong.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-4}{%
\subsection{Discussion}\label{discussion-4}}

\begin{itemize}
\item
  Energy optimization in mid-2017 is clearly visible in the trend and also in the magnitude of the seasonal pattern
\item
  And as well in the remainder the too low setting of January 2018 where the thermostat of the flat got deactivated
\item
  The trend shows as well an higher consumption in June 2013
\end{itemize}

\newpage

\hypertarget{short-term}{%
\section{Short term}\label{short-term}}

\hypertarget{goal-5}{%
\subsection{Goal}\label{goal-5}}

Decompose a short term time series of e.g.~5 days 15min data.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDecompositionShort} \caption{Seasonal Plot Overlapping per Month over 10 Years}\label{fig:unnamed-chunk-14}
\end{figure}

\hypertarget{data-basis-5}{%
\subsection{Data Basis}\label{data-basis-5}}

In general, the values of energy meters, as in our example, increase steadily:

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDecompositionShort0-1.pdf}
\caption{\label{fig:dataVisDecompositionShort0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-5}{%
\subsection{Solution}\label{solution-5}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(forecast)}

\CommentTok{# change language to English, otherwise weekdays are in local language}
\KeywordTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC_TIME"}\NormalTok{, }\StringTok{"English"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "English_United States.1252"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# load time series data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/eboBookEleMeter.csv"}\NormalTok{,}
               \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\CommentTok{# rename column names}
\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"time"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\NormalTok{df}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(df}\OperatorTok{$}\NormalTok{time,}
                                \DataTypeTok{orders =} \StringTok{"YmdHMS"}\NormalTok{,}
                                \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{force_tz}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{tzone =} \StringTok{"UTC"}\NormalTok{)}

\CommentTok{# uncomment to filter time range if necessary}
\CommentTok{#df <- df %>% filter(Time > "2015-03-01 00:00:00", Time < "2015-04-01 00:00:00")}

\CommentTok{# Fill missing values with NA}
\NormalTok{grid.df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{time =} \KeywordTok{seq}\NormalTok{(}\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                      \KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                      \DataTypeTok{by =} \StringTok{"15 mins"}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(df, grid.df, }\DataTypeTok{all =} \OtherTok{TRUE}\NormalTok{)}

\CommentTok{# convert steadily counting energy meter value from kWh to power in kW}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =}\NormalTok{ (meterValue }\OperatorTok{-}\StringTok{ }\KeywordTok{lag}\NormalTok{(meterValue))}\OperatorTok{*}\DecValTok{4}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# remove negative values which occur beause of change summer/winter time}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(value }\OperatorTok{>=}\StringTok{ }\DecValTok{0}\NormalTok{)}

\CommentTok{# select time range}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(time }\OperatorTok{>=}\StringTok{ }\KeywordTok{as.POSIXct}\NormalTok{(}\StringTok{"2015-01-26 00:00:00"}\NormalTok{, }\DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{),}
\NormalTok{                    time }\OperatorTok{<}\StringTok{ }\KeywordTok{as.POSIXct}\NormalTok{(}\StringTok{"2015-01-31 00:00:00"}\NormalTok{, }\DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{))}

\CommentTok{# =========== Start of Code ================}
\NormalTok{df.ts <-}\StringTok{ }\KeywordTok{ts}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(value) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{(),}
            \DataTypeTok{frequency =} \DecValTok{96}\NormalTok{)}

\NormalTok{df.decompose <-}\StringTok{ }\NormalTok{df.ts[,}\DecValTok{1}\NormalTok{] }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{stl}\NormalTok{(}\DataTypeTok{s.window =} \DecValTok{193}\NormalTok{)}

\NormalTok{df.decompose <-}\StringTok{ }\NormalTok{df.decompose}\OperatorTok{$}\NormalTok{time.series}

\NormalTok{df.decompose <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(df.decompose)}

\NormalTok{df.decompose <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(df, df.decompose)}

\NormalTok{data <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(tidyr}\OperatorTok{::}\KeywordTok{pivot_longer}\NormalTok{(df.decompose,}
                                          \DataTypeTok{cols =} \OperatorTok{-}\NormalTok{time,}
                                          \DataTypeTok{names_to =} \StringTok{"component"}\NormalTok{,}
                                          \DataTypeTok{values_to =} \StringTok{"value"}\NormalTok{,}
                                          \DataTypeTok{values_drop_na =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{)}
\NormalTok{data}\OperatorTok{$}\NormalTok{component <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{component)}
\NormalTok{data}\OperatorTok{$}\NormalTok{component <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{component, }\KeywordTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}
                                           \StringTok{"trend"}\NormalTok{,}
                                           \StringTok{"seasonal"}\NormalTok{,}
                                           \StringTok{"remainder"}\NormalTok{))}
\CommentTok{# prepare data for plot}

\NormalTok{componentTitles =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Raw Data"}\NormalTok{,}\StringTok{"Trend Component"}\NormalTok{, }\StringTok{"Seasonal Component"}\NormalTok{, }\StringTok{"Remainder"}\NormalTok{)}

\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{component =} \KeywordTok{recode}\NormalTok{(component,}
                            \DataTypeTok{value =}\NormalTok{ componentTitles[}\DecValTok{1}\NormalTok{],}
                            \DataTypeTok{trend =}\NormalTok{ componentTitles[}\DecValTok{2}\NormalTok{],}
                            \DataTypeTok{seasonal =}\NormalTok{ componentTitles[}\DecValTok{3}\NormalTok{],}
                            \DataTypeTok{remainder =}\NormalTok{ componentTitles[}\DecValTok{4}\NormalTok{]),}
         \DataTypeTok{value =} \KeywordTok{round}\NormalTok{(data}\OperatorTok{$}\NormalTok{value, }\DataTypeTok{digits =} \DecValTok{1}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{rename}\NormalTok{(}\DataTypeTok{Value =}\NormalTok{ value,}
         \DataTypeTok{Time =}\NormalTok{ time)}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggplot}\NormalTok{(data) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_path}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ Time,}
                \DataTypeTok{y =}\NormalTok{ Value}
\NormalTok{               ),}
            \DataTypeTok{color =} \StringTok{"black"}\NormalTok{,}
            \DataTypeTok{alpha =} \FloatTok{0.7}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{component, }\DataTypeTok{ncol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{scales =} \StringTok{"free_y"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_x_datetime}\NormalTok{(}\DataTypeTok{date_breaks =} \StringTok{"days"}\NormalTok{ , }\DataTypeTok{date_labels =} \StringTok{"%a}\CharTok{\textbackslash{}n}\StringTok{%d. %b}\CharTok{\textbackslash{}n}\StringTok{%H:%M"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_minimal}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{panel.spacing =} \KeywordTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"lines"}\NormalTok{),}
        \DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \StringTok{""}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Time Series Decomposition over 5 days"}\NormalTok{)}

\KeywordTok{ggplotly}\NormalTok{(plot)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDecompositionShort1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotDecompositionShort.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{heat-maps}{%
\chapter{Heat Maps}\label{heat-maps}}

Temporal patterns can show at what time certain devices are exposed to how much load. Heatmaps show quantitative values based on two axes. These can be day and hours, month and day, etc. The cell at the intersection contains the corresponding value. Depending on the context, this can be an average value, a maximum/minimum value, etc. This representation allows the viewer to see short-term patterns and long-term trends in the data with a higher temporal granularity.

This chapter shows different types of heat maps which are useful for energy data analysis and pattern recognition.

\newpage

\hypertarget{calendar}{%
\section{Calendar}\label{calendar}}

\hypertarget{goal-6}{%
\subsection{Goal}\label{goal-6}}

Create a calendar heat map with daily energy consumption values.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotHeatMapCalendar} \caption{Calendar Heat Map}\label{fig:unnamed-chunk-15}
\end{figure}

\hypertarget{data-basis-6}{%
\subsection{Data Basis}\label{data-basis-6}}

Daily energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisHeatmapCalendar1-1.pdf}
\caption{\label{fig:dataVisHeatmapCalendar1}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-6}{%
\subsection{Solution}\label{solution-6}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(ggTimeSeries)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(tidyquant)}

\NormalTok{data <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}

\NormalTok{data <-}\StringTok{ }\NormalTok{data[}\OperatorTok{-}\KeywordTok{nrow}\NormalTok{(data),]}

\NormalTok{data}\OperatorTok{$}\NormalTok{timestamp <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(data}\OperatorTok{$}\NormalTok{timestamp,}
                                      \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                                      \DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{)}

\NormalTok{data}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(lubridate}\OperatorTok{::}\KeywordTok{floor_date}\NormalTok{(data}\OperatorTok{$}\NormalTok{timestamp,}\StringTok{"day"}\NormalTok{))}

\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{timestamp)}

\NormalTok{data.plot <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{calcVal =} \KeywordTok{sum}\NormalTok{(value, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ungroup}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{value) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{unique}\NormalTok{()}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{ggplot_calendar_heatmap}\NormalTok{(data.plot,}
                             \StringTok{"day"}\NormalTok{,}
                             \StringTok{"calcVal"}\NormalTok{,}
                             \DataTypeTok{monthBorderSize =} \DecValTok{1}\NormalTok{,}
                             \DataTypeTok{monthBorderColour =} \StringTok{"white"}\NormalTok{,}
                             \DataTypeTok{monthBorderLineEnd =} \StringTok{"square"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_fill_viridis_c}\NormalTok{(}\DataTypeTok{option =} \StringTok{"B"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_minimal}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{axis.title.y =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"grey30"}\NormalTok{, }\DataTypeTok{size =} \DecValTok{10}\NormalTok{, }\DataTypeTok{face =} \StringTok{"plain"}\NormalTok{),}
\NormalTok{                   )}\OperatorTok{+}
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Month"}\NormalTok{,}
       \DataTypeTok{y =} \StringTok{"Energy Consumption}\CharTok{\textbackslash{}n}\StringTok{(kWh/d)}\CharTok{\textbackslash{}n}\StringTok{ "}\NormalTok{,}
       \DataTypeTok{fill =} \StringTok{"Legend"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{Year, }\DataTypeTok{ncol =} \DecValTok{1}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Calendar Plot Energy Consumption}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}

\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisHeatmapCalendar2-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# create the interactive plot (optional, uncomment line)}
\CommentTok{#ggplotly(plot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotHeatMapCalendar.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-5}{%
\subsection{Discussion}\label{discussion-5}}

Some findings:

\begin{itemize}
\item
  first two days in year minimal consumption
\item
  6th of April: Easter Monday
\item
  25th of May: Whitmonday (de: Pfingstmontag)
\item
  More usage in August
\item
  In November one Sunday with unusual high consumption
\item
  On Fridays in general less consumption
\end{itemize}

\newpage

\hypertarget{median-weeks}{%
\section{Median-Weeks}\label{median-weeks}}

\hypertarget{goal-7}{%
\subsection{Goal}\label{goal-7}}

Create an energy consumption heat map of a typical weeks depending on the season of the year.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotHeatMapMedianWeeks} \caption{Heat Map of Median Weeks per Season of Year}\label{fig:unnamed-chunk-16}
\end{figure}

\hypertarget{data-basis-7}{%
\subsection{Data Basis}\label{data-basis-7}}

Daily energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisHeatmapMedianWeeks0-1.pdf}
\caption{\label{fig:dataVisHeatmapMedianWeeks0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-7}{%
\subsection{Solution}\label{solution-7}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(plotly)}

\NormalTok{data <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}
\NormalTok{plot <-}\StringTok{ }\KeywordTok{plotHeatmapMedianWeeks}\NormalTok{(data, }\DataTypeTok{locTimeZone =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\CommentTok{# show the static plot}
\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisHeatmapMedianWeeks1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# create the interactive plot (optional, uncomment line)}
\CommentTok{#ggplotly(plot)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotHeatMapMedianWeeks.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{discussion-6}{%
\subsection{Discussion}\label{discussion-6}}

Some findings:

\begin{itemize}
\item
  Increased consumption at midnight, but not visible in Summer, probably heating affected
\item
  Clearly less consumption at weekends, starting already friday afternoon
\item
  High peaks on Tuesdays and Thursdays in summer
\end{itemize}

\hypertarget{typical-daily-profiles}{%
\chapter{Typical Daily Profiles}\label{typical-daily-profiles}}

An important step in energy data analysis is the recognition of patterns. For this purpose, the data are first aggregated to hourly values, averaged and displayed as typical daily patterns. The daily profiles can be displayed separately for the weekdays and the seasons.

This chapter shows some useful visualizations to accommodate this recognition.

\newpage

\hypertarget{overview}{%
\section{Overview}\label{overview}}

\hypertarget{goal-8}{%
\subsection{Goal}\label{goal-8}}

Create an overview of typical daily profiles per weekday and season of year with a confidence band where most of the values lie.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDailyProfOverview} \caption{Overview of Daily Profiles by Weekday and Season}\label{fig:unnamed-chunk-17}
\end{figure}

\hypertarget{data-basis-8}{%
\subsection{Data Basis}\label{data-basis-8}}

Energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDailyProfilesOverview0-1.pdf}
\caption{\label{fig:dataVisDailyProfilesOverview0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-8}{%
\subsection{Solution}\label{solution-8}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(plotly)}

\CommentTok{# load time series data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}

\NormalTok{plot <-}\StringTok{ }\KeywordTok{plotDailyProfilesOverview}\NormalTok{(df,}
                               \DataTypeTok{locTimeZone =} \StringTok{"Europe/Zurich"}\NormalTok{,}
                               \DataTypeTok{main =} \StringTok{"Daily Profiles Overview by Weekday and Season"}\NormalTok{,}
                               \DataTypeTok{ylab =} \StringTok{"Power (kW)"}\NormalTok{,}
                               \DataTypeTok{col =} \StringTok{"black"}\NormalTok{,}
                               \DataTypeTok{confidence =} \FloatTok{95.0}\NormalTok{)}

\KeywordTok{ggplotly}\NormalTok{(plot)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDailyProfilesOverview1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotDailyProfOverview.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\newpage

\hypertarget{overlayed}{%
\section{Overlayed}\label{overlayed}}

\hypertarget{goal-9}{%
\subsection{Goal}\label{goal-9}}

Create a plot of all data per week by season of the year.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDailyProfOverlayed} \caption{Overlayed Daily Profiles}\label{fig:unnamed-chunk-18}
\end{figure}

\hypertarget{data-basis-9}{%
\subsection{Data Basis}\label{data-basis-9}}

Energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDailyProfilesOverlayed0-1.pdf}
\caption{\label{fig:dataVisDailyProfilesOverlayed0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-9}{%
\subsection{Solution}\label{solution-9}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# change language to English, otherwise weekdays are in local language}
\KeywordTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC_TIME"}\NormalTok{, }\StringTok{"English"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "English_United States.1252"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# load time series data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{value =}\NormalTok{ value }\OperatorTok{*}\StringTok{ }\DecValTok{4}\NormalTok{)}

\CommentTok{# add metadata for later grouping and visualization purposes}
\NormalTok{df}\OperatorTok{$}\NormalTok{x <-}\StringTok{ }\KeywordTok{hour}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp) }\OperatorTok{+}\StringTok{ }\KeywordTok{minute}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)}\OperatorTok{/}\DecValTok{60} \OperatorTok{+}\StringTok{ }\KeywordTok{second}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp) }\OperatorTok{/}\StringTok{ }\DecValTok{3600}
\NormalTok{df}\OperatorTok{$}\NormalTok{weekday <-}\StringTok{ }\KeywordTok{weekdays}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)}
\NormalTok{df}\OperatorTok{$}\NormalTok{weekday <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(df}\OperatorTok{$}\NormalTok{weekday, }\KeywordTok{c}\NormalTok{(}\StringTok{"Monday"}\NormalTok{,}\StringTok{"Tuesday"}\NormalTok{,}\StringTok{"Wednesday"}\NormalTok{,}\StringTok{"Thursday"}\NormalTok{,}\StringTok{"Friday"}\NormalTok{,}\StringTok{"Saturday"}\NormalTok{, }\StringTok{"Sunday"}\NormalTok{))}
\NormalTok{df}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\DataTypeTok{format =} \StringTok{"%Y-%m-%d  %H:%M:%S"}\NormalTok{)}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{ifelse}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\FloatTok{0.00}\NormalTok{, }\OtherTok{NA}\NormalTok{, df}\OperatorTok{$}\NormalTok{value))}

\CommentTok{# plot graph with all time series}
\NormalTok{rangeX <-}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{24}\NormalTok{,}\FloatTok{0.25}\NormalTok{)}
\NormalTok{maxValue <-}\StringTok{ }\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{value, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}\OperatorTok{*}\FloatTok{1.05}

\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{highlight_key}\NormalTok{(}\OperatorTok{~}\NormalTok{day) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{plot_ly}\NormalTok{(}\DataTypeTok{x=}\OperatorTok{~}\NormalTok{x,}
          \DataTypeTok{y=}\OperatorTok{~}\NormalTok{value,}
          \DataTypeTok{color=}\OperatorTok{~}\NormalTok{weekday,}
          \DataTypeTok{type=}\StringTok{"scatter"}\NormalTok{,}
          \DataTypeTok{mode=}\StringTok{"lines"}\NormalTok{,}
          \DataTypeTok{line =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{width =} \DecValTok{1}\NormalTok{),}
          \DataTypeTok{alpha =} \FloatTok{0.15}\NormalTok{,}
          \DataTypeTok{colors =} \StringTok{"dodgerblue4"}\NormalTok{,}
          \DataTypeTok{text =} \OperatorTok{~}\NormalTok{day,}
          \DataTypeTok{hovertemplate =} \KeywordTok{paste}\NormalTok{(}\StringTok{"Time: "}\NormalTok{, }\KeywordTok{format}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\StringTok{"%H:%M"}\NormalTok{),}
                                \StringTok{"<br>Date: "}\NormalTok{, }\KeywordTok{format}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\StringTok{"%Y-%m-%d"}\NormalTok{),}
                                \StringTok{"<br>Value: %\{y:.0f\}"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\CommentTok{# workaround with add_trace to have fixed y axis when selecting a dedicated day}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{x =} \DecValTok{0}\NormalTok{, }\DataTypeTok{y =} \DecValTok{0}\NormalTok{, }\DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{, }\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{opacity=}\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{x =} \DecValTok{24}\NormalTok{, }\DataTypeTok{y =}\NormalTok{ maxValue, }\DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{, }\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{opacity=}\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{layout}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Daily Profiles - Overlayed"}\NormalTok{,}
         \DataTypeTok{showlegend =} \OtherTok{TRUE}\NormalTok{,}
         \DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}
           \DataTypeTok{title =} \StringTok{"Hour of day"}\NormalTok{,}
           \DataTypeTok{range =}\NormalTok{ rangeX,}
           \DataTypeTok{tickvals =} \KeywordTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{21}\NormalTok{),}
           \DataTypeTok{showline=}\OtherTok{TRUE}
\NormalTok{           ),}
           \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}
             \DataTypeTok{title =} \StringTok{"Power (kW)"}\NormalTok{,}
             \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, maxValue)}
\NormalTok{           )}
\NormalTok{         ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{highlight}\NormalTok{(}\DataTypeTok{on =} \StringTok{"plotly_hover"}\NormalTok{,}
            \DataTypeTok{off =} \StringTok{"plotly_doubleclick"}\NormalTok{,}
            \DataTypeTok{color =} \StringTok{"orange"}\NormalTok{,}
            \DataTypeTok{opacityDim =} \FloatTok{1.0}\NormalTok{,}
            \DataTypeTok{selected =} \KeywordTok{attrs_selected}\NormalTok{(}\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{# this hides elements in the legend}
\StringTok{  }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{config}\NormalTok{(}\DataTypeTok{modeBarButtons =} \KeywordTok{list}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)), }\DataTypeTok{displaylogo =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDailyProfilesOverlayed1-1.pdf}

\newpage

\hypertarget{mean}{%
\section{Mean}\label{mean}}

\hypertarget{goal-10}{%
\subsection{Goal}\label{goal-10}}

Create a plot of mean data per week.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDailyProfMean} \caption{Mean Daily Profiles per Weekday}\label{fig:unnamed-chunk-19}
\end{figure}

\hypertarget{data-basis-10}{%
\subsection{Data Basis}\label{data-basis-10}}

Energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDailyProfilesMean0-1.pdf}
\caption{\label{fig:dataVisDailyProfilesMean0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-10}{%
\subsection{Solution}\label{solution-10}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# change language to English, otherwise weekdays are in local language}
\KeywordTok{Sys.setlocale}\NormalTok{(}\StringTok{"LC_TIME"}\NormalTok{, }\StringTok{"English"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "English_United States.1252"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# load time series data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{value =}\NormalTok{ value }\OperatorTok{*}\StringTok{ }\DecValTok{4}\NormalTok{)}

\CommentTok{# add metadata for later grouping and visualization purposes}
\NormalTok{df}\OperatorTok{$}\NormalTok{x <-}\StringTok{ }\KeywordTok{hour}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp) }\OperatorTok{+}\StringTok{ }\KeywordTok{minute}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)}\OperatorTok{/}\DecValTok{60} \OperatorTok{+}\StringTok{ }\KeywordTok{second}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp) }\OperatorTok{/}\StringTok{ }\DecValTok{3600}
\NormalTok{df}\OperatorTok{$}\NormalTok{weekday <-}\StringTok{ }\KeywordTok{weekdays}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp)}
\NormalTok{df}\OperatorTok{$}\NormalTok{weekday <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(df}\OperatorTok{$}\NormalTok{weekday, }\KeywordTok{c}\NormalTok{(}\StringTok{"Monday"}\NormalTok{,}\StringTok{"Tuesday"}\NormalTok{,}\StringTok{"Wednesday"}\NormalTok{,}\StringTok{"Thursday"}\NormalTok{,}\StringTok{"Friday"}\NormalTok{,}\StringTok{"Saturday"}\NormalTok{, }\StringTok{"Sunday"}\NormalTok{))}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =} \KeywordTok{ifelse}\NormalTok{(x }\OperatorTok{==}\StringTok{ }\FloatTok{0.00}\NormalTok{, }\OtherTok{NA}\NormalTok{, df}\OperatorTok{$}\NormalTok{value))}

\CommentTok{# Calculate Mean value for all 15 minutes for each weekday}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{group_by}\NormalTok{(weekday, x) }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{dayTimeMean =} \KeywordTok{mean}\NormalTok{(value)) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{ungroup}\NormalTok{()}

\CommentTok{# shrink data frame}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(x, weekday, timestamp, dayTimeMean) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{arrange}\NormalTok{(weekday, x)}

\CommentTok{# plot graph with mean values}
\NormalTok{maxValMean <-}\StringTok{ }\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{dayTimeMean, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}\OperatorTok{*}\FloatTok{1.05}

\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{highlight_key}\NormalTok{(}\OperatorTok{~}\NormalTok{weekday) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{plot_ly}\NormalTok{(}\DataTypeTok{x=}\OperatorTok{~}\NormalTok{x,}
          \DataTypeTok{y=}\OperatorTok{~}\NormalTok{dayTimeMean,}
          \DataTypeTok{color=}\OperatorTok{~}\NormalTok{weekday,}
          \DataTypeTok{type=}\StringTok{"scatter"}\NormalTok{,}
          \DataTypeTok{mode=}\StringTok{"lines"}\NormalTok{,}
          \DataTypeTok{alpha =} \FloatTok{0.25}\NormalTok{,}
          \DataTypeTok{colors =} \StringTok{"dodgerblue4"}\NormalTok{,}
          \DataTypeTok{text =} \OperatorTok{~}\NormalTok{weekday,}
          \DataTypeTok{hovertemplate =} \KeywordTok{paste}\NormalTok{(}\StringTok{"Time: "}\NormalTok{, }\KeywordTok{format}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\StringTok{"%H:%M"}\NormalTok{),}
                                \StringTok{"<br>Mean: %\{y:.0f\}"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\CommentTok{# workaround with add_trace to have fixed y axis when selecting a dedicated day}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{x =} \DecValTok{0}\NormalTok{, }\DataTypeTok{y =} \DecValTok{0}\NormalTok{, }\DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{, }\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{opacity=}\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{x =} \DecValTok{24}\NormalTok{, }\DataTypeTok{y =}\NormalTok{ maxValMean, }\DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{, }\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{opacity=}\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{layout}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Daily Profiles - Mean"}\NormalTok{,}
         \DataTypeTok{showlegend =} \OtherTok{TRUE}\NormalTok{,}
         \DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}
           \DataTypeTok{title =} \StringTok{"Hour of day"}\NormalTok{,}
           \DataTypeTok{tickvals =} \KeywordTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{18}\NormalTok{, }\DecValTok{21}\NormalTok{)}
\NormalTok{         ),}
         \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}
             \DataTypeTok{title =} \StringTok{"Power (kW)"}\NormalTok{,}
             \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, maxValMean)}
\NormalTok{         )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{highlight}\NormalTok{(}\DataTypeTok{on =} \StringTok{"plotly_hover"}\NormalTok{,}
            \DataTypeTok{off =} \StringTok{"plotly_doubleclick"}\NormalTok{,}
            \DataTypeTok{color =} \StringTok{"orange"}\NormalTok{,}
            \DataTypeTok{opacityDim =} \FloatTok{0.7}\NormalTok{,}
            \DataTypeTok{selected =} \KeywordTok{attrs_selected}\NormalTok{(}\DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{# this hides elements in the legend}
\StringTok{  }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{config}\NormalTok{(}\DataTypeTok{modeBarButtons =} \KeywordTok{list}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)), }\DataTypeTok{displaylogo =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDailyProfilesMean1 plotly-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotDailyProfMean.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\newpage

\hypertarget{dailyProfilesDecomposed}{%
\section{Decomposed}\label{dailyProfilesDecomposed}}

\hypertarget{goal-11}{%
\subsection{Goal}\label{goal-11}}

Create a plot of detrended mean data per week as recommended in \href{https://doi.org/10.1016/j.enbuild.2018.07.056}{``Building electricity consumption: Data analytics of building operations with classical time series decomposition and case based subsetting'', Pickering et al, 2018}

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotDailyProfDecomposed} \caption{Mean Daily Profiles per Weekday}\label{fig:unnamed-chunk-20}
\end{figure}

\hypertarget{data-basis-11}{%
\subsection{Data Basis}\label{data-basis-11}}

Energy consumption values of one whole year in an interval of 15mins.

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/dataVisDailyProfilesDecomposed0-1.pdf}
\caption{\label{fig:dataVisDailyProfilesDecomposed0}Raw Data for Decomposition Plot Short Term}
\end{figure}

\hypertarget{solution-11}{%
\subsection{Solution}\label{solution-11}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(redutils)}

\CommentTok{# load time series data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{readRDS}\NormalTok{(}\KeywordTok{system.file}\NormalTok{(}\StringTok{"sampleData/eboBookEleMeter.rds"}\NormalTok{, }\DataTypeTok{package =} \StringTok{"redutils"}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\KeywordTok{mutate}\NormalTok{(df, }\DataTypeTok{value =}\NormalTok{ value }\OperatorTok{*}\StringTok{ }\DecValTok{4}\NormalTok{)}

\NormalTok{p <-}\StringTok{ }\KeywordTok{plotDailyProfilesDecomposed}\NormalTok{(df, }\DataTypeTok{locTimeZone =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\KeywordTok{ggplotly}\NormalTok{(p)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/dataVisDailyProfilesDecomposed1 plotly-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{ggsave}\NormalTok{(}\StringTok{"images/plotDailyProfDecomposed.png"}\NormalTok{, plot)}
\end{Highlighting}
\end{Shaded}

\hypertarget{comfort-plots}{%
\chapter{Comfort Plots}\label{comfort-plots}}

Satisfied and healthy residents are important, thus an energetic optimization should not influence the comfort if possible. The recipes in this chapter focus on some typical comfort related visualizations which help identifying multiple problems like moisture and damage of wooden floor because of the humidity influence.

This chapter shows how to create some popular comfort plots.

\newpage

\hypertarget{mollier-hx-diagram}{%
\section{Mollier hx Diagram}\label{mollier-hx-diagram}}

\hypertarget{goal-12}{%
\subsection{Goal}\label{goal-12}}

You want to plot a mollier h-x diagram:

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/comfortMollierHx} \caption{Mollier hx Diagram with comfort zone}\label{fig:unnamed-chunk-21}
\end{figure}

\hypertarget{data-basis-12}{%
\subsection{Data Basis}\label{data-basis-12}}

\includegraphics{edar_files/figure-latex/mollierhx0-1.pdf} \includegraphics{edar_files/figure-latex/mollierhx0-2.pdf}

\hypertarget{solution-12}{%
\subsection{Solution}\label{solution-12}}

The sensor data is not in a constant intervall and not yet aggregated. So after reading in the time series the data has to get filtered and aggregated per day.

Finally use the plot function \texttt{mollierHxDiagram} from the \texttt{redutils} package (R Energy Data Utilities).
If you have not yet installed this package, proceed as follows:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"devtools"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(devtools)}
\KeywordTok{install_github}\NormalTok{(}\StringTok{"hslu-ige-laes/redutils"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}

\CommentTok{# read and print data}
\NormalTok{data <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatTempHum.csv"}\NormalTok{,}
                 \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                 \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\CommentTok{# select temperature and humidity and remove empty cells}
\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(time, FlatA_Temp, FlatA_Hum) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# create column with day for later grouping}
\NormalTok{data}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(data}\OperatorTok{$}\NormalTok{time, }\StringTok{"YmdHMS"}\NormalTok{, }\DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}
\NormalTok{data}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(data}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"day"}\NormalTok{))}

\CommentTok{# calculate daily mean of temperature and humidity}
\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{tempMean =} \KeywordTok{mean}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(FlatA_Temp)),}
         \DataTypeTok{humMean =} \KeywordTok{mean}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(FlatA_Hum))}
\NormalTok{         ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}

\CommentTok{# shrink down to daily values and remove rows with empty values}
\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(day, tempMean, humMean) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# plot mollier hx diagram}
\NormalTok{plot <-}\StringTok{ }\KeywordTok{plotMollierHx}\NormalTok{(data)}

\NormalTok{plot}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/mollierhx1-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# save static plot as png (optional)}
\KeywordTok{library}\NormalTok{(r2d3)}
\KeywordTok{save_d3_png}\NormalTok{(plot, }\StringTok{"images/comfortMollierHx.png"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\hypertarget{sia-180-thermal-comfort}{%
\section{SIA 180 Thermal Comfort}\label{sia-180-thermal-comfort}}

\hypertarget{goal-13}{%
\subsection{Goal}\label{goal-13}}

You want to plot a diagram like the one from the SIA 180:2014

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/comfortSia180ThermCmf} \caption{Thermal Comfort according to SIA 180:2014}\label{fig:unnamed-chunk-23}
\end{figure}

\hypertarget{data-basis-13}{%
\subsection{Data Basis}\label{data-basis-13}}

\includegraphics{edar_files/figure-latex/comfortSia180ThermCmf0-1.pdf} \includegraphics{edar_files/figure-latex/comfortSia180ThermCmf0-2.pdf}

\hypertarget{solution-13}{%
\subsection{Solution}\label{solution-13}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(zoo)}
\KeywordTok{library}\NormalTok{(plotly)}

\CommentTok{# load time series data and aggregate mean values}
\NormalTok{dfTempOa <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/centralOutsideTemp.csv"}\NormalTok{,}
                          \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                          \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfTempOa}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfTempOa}\OperatorTok{$}\NormalTok{time,}
                                      \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                                      \DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{)}

\NormalTok{dfTempOa}\OperatorTok{$}\NormalTok{hour <-}\StringTok{ }\KeywordTok{cut}\NormalTok{(dfTempOa}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"hour"}\NormalTok{)}

\NormalTok{dfTempOa <-}\StringTok{ }\NormalTok{dfTempOa }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(hour) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{tempMean =} \KeywordTok{mean}\NormalTok{(centralOutsideTemp)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(time, tempMean) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{unique}\NormalTok{()}

\CommentTok{# Fill missing values with NA}
\NormalTok{grid.df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{time =} \KeywordTok{seq}\NormalTok{(}\KeywordTok{min}\NormalTok{(dfTempOa}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                 \KeywordTok{max}\NormalTok{(dfTempOa}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                 \DataTypeTok{by =} \StringTok{"hour"}\NormalTok{))}
\NormalTok{dfTempOa <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(dfTempOa, grid.df, }\DataTypeTok{all =} \OtherTok{TRUE}\NormalTok{)}

\NormalTok{dfTempOa <-}\StringTok{ }\NormalTok{dfTempOa }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{tempOa =} \KeywordTok{rollmean}\NormalTok{(tempMean, }\DecValTok{48}\NormalTok{, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{, }\DataTypeTok{align =} \StringTok{"right"}\NormalTok{))}

\NormalTok{dfTempOa <-}\StringTok{ }\NormalTok{dfTempOa }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(time, tempOa) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}


\NormalTok{dfTempR <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatTempHum.csv"}\NormalTok{,}
                       \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                       \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfTempR}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfTempR}\OperatorTok{$}\NormalTok{time,}
                                   \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                                   \DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{)}

\CommentTok{# select temperature and humidity and remove empty cells}
\NormalTok{dfTempR <-}\StringTok{ }\NormalTok{dfTempR }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(time, FlatA_Temp) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\NormalTok{dfTempR}\OperatorTok{$}\NormalTok{hour <-}\StringTok{ }\KeywordTok{cut}\NormalTok{(dfTempR}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"hour"}\NormalTok{)}

\NormalTok{dfTempR <-}\StringTok{ }\NormalTok{dfTempR }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(hour) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{tempR =} \KeywordTok{mean}\NormalTok{(FlatA_Temp)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(time, tempR) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{unique}\NormalTok{()}

\CommentTok{# Fill missing values with NA}
\NormalTok{grid.df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{time =} \KeywordTok{seq}\NormalTok{(}\KeywordTok{min}\NormalTok{(dfTempR}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                 \KeywordTok{max}\NormalTok{(dfTempR}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                 \DataTypeTok{by =} \StringTok{"hour"}\NormalTok{))}
\NormalTok{dfTempR <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(dfTempR, grid.df, }\DataTypeTok{all =} \OtherTok{TRUE}\NormalTok{)}

\NormalTok{data <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(dfTempR, dfTempOa, }\DataTypeTok{all =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\NormalTok{data}\OperatorTok{$}\NormalTok{season <-}\StringTok{ }\NormalTok{redutils}\OperatorTok{::}\KeywordTok{getSeason}\NormalTok{(data}\OperatorTok{$}\NormalTok{time)}

\CommentTok{# plot diagram}

\CommentTok{# axis properties}
\NormalTok{minx <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(}\KeywordTok{min}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{min}\NormalTok{(data}\OperatorTok{$}\NormalTok{tempOa)))}
\NormalTok{maxx <-}\StringTok{ }\KeywordTok{ceiling}\NormalTok{(}\KeywordTok{max}\NormalTok{(}\DecValTok{28}\NormalTok{, }\KeywordTok{max}\NormalTok{(data}\OperatorTok{$}\NormalTok{tempOa)))}

\NormalTok{miny <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(}\KeywordTok{min}\NormalTok{(}\FloatTok{21.0}\NormalTok{,}\KeywordTok{min}\NormalTok{(data}\OperatorTok{$}\NormalTok{tempR)))}\OperatorTok{-}\DecValTok{1}
\NormalTok{maxy <-}\StringTok{ }\KeywordTok{ceiling}\NormalTok{(}\KeywordTok{max}\NormalTok{(}\FloatTok{32.0}\NormalTok{,}\KeywordTok{max}\NormalTok{(data}\OperatorTok{$}\NormalTok{tempR)))}\OperatorTok{+}\DecValTok{1}

\CommentTok{# line setpoint heat}
\NormalTok{df.heatSp <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{tempOa =} \KeywordTok{c}\NormalTok{(minx, }\DecValTok{19}\NormalTok{, }\FloatTok{23.5}\NormalTok{, maxx), }\DataTypeTok{tempR =} \KeywordTok{c}\NormalTok{(}\FloatTok{20.5}\NormalTok{, }\FloatTok{20.5}\NormalTok{, }\DecValTok{22}\NormalTok{, }\DecValTok{22}\NormalTok{))}

\CommentTok{# line setpoint cool according to SIA 180:2014 Fig. 4}
\NormalTok{df.coolSp1 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{tempOa =} \KeywordTok{c}\NormalTok{(minx, }\DecValTok{12}\NormalTok{, }\FloatTok{17.5}\NormalTok{, maxx),}\DataTypeTok{tempR =} \KeywordTok{c}\NormalTok{(}\FloatTok{24.5}\NormalTok{, }\FloatTok{24.5}\NormalTok{, }\FloatTok{26.5}\NormalTok{, }\FloatTok{26.5}\NormalTok{))}

\CommentTok{# line setpoint cool according to SIA 180:2014 Fig. 3}
\NormalTok{df.coolSp2 <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{tempOa =} \KeywordTok{c}\NormalTok{(minx, }\DecValTok{10}\NormalTok{, maxx),}\DataTypeTok{tempR =} \KeywordTok{c}\NormalTok{(}\DecValTok{25}\NormalTok{, }\DecValTok{25}\NormalTok{, }\FloatTok{0.33} \OperatorTok{*}\StringTok{ }\NormalTok{maxx }\OperatorTok{+}\StringTok{ }\FloatTok{21.8}\NormalTok{))}

\NormalTok{data }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{plot_ly}\NormalTok{(}\DataTypeTok{showlegend =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_lines}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df.coolSp2,}
            \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
            \DataTypeTok{name =} \StringTok{"Upper limit SIA 180 passive cooling"}\NormalTok{,}
            \DataTypeTok{opacity =} \FloatTok{0.7}\NormalTok{,}
            \DataTypeTok{color =} \StringTok{"#FDE725FF"}\NormalTok{,}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"Upper limit SIA 180 passive cooling"}\NormalTok{,}
                           \StringTok{"<br />TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                           \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa)}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_lines}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df.coolSp1,}
            \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
            \DataTypeTok{name =} \StringTok{"Upper limit SIA 180 active cooling"}\NormalTok{,}
            \DataTypeTok{opacity =} \FloatTok{0.7}\NormalTok{,}
            \DataTypeTok{color =} \StringTok{"#1E9B8AFF"}\NormalTok{,}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"Upper limit SIA 180 active cooling"}\NormalTok{,}
                           \StringTok{"<br />TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                           \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa)}
\NormalTok{            )        ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_lines}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df.heatSp,}
            \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
            \DataTypeTok{name =} \StringTok{"Lower Limit SIA 180"}\NormalTok{,}
            \DataTypeTok{opacity =} \FloatTok{0.7}\NormalTok{,}
            \DataTypeTok{color =} \StringTok{"#440154FF"}\NormalTok{,}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"Lower Limit SIA 180"}\NormalTok{,}
                           \StringTok{"<br />TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                           \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa)}
\NormalTok{            )        ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_markers}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Spring"}\NormalTok{),}
              \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
              \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
              \DataTypeTok{name =} \StringTok{"Spring"}\NormalTok{,}
              \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#2db27d"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.1}\NormalTok{),}
              \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
              \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                             \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa),}
                             \StringTok{"<br />Date:       "}\NormalTok{, time,}
                             \StringTok{"<br />Season:  "}\NormalTok{, season}
\NormalTok{              )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_markers}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Summer"}\NormalTok{),}
              \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
              \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
              \DataTypeTok{name =} \StringTok{"Summer"}\NormalTok{,}
              \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#febc2b"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.1}\NormalTok{),}
              \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
              \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                             \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa),}
                             \StringTok{"<br />Date:       "}\NormalTok{, time,}
                             \StringTok{"<br />Season:  "}\NormalTok{, season}
\NormalTok{              )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_markers}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Fall"}\NormalTok{),}
              \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
              \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
              \DataTypeTok{name =} \StringTok{"Fall"}\NormalTok{,}
              \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#440154"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.1}\NormalTok{),}
              \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
              \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                             \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa),}
                             \StringTok{"<br />Date:       "}\NormalTok{, time,}
                             \StringTok{"<br />Season:  "}\NormalTok{, season}
\NormalTok{              )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_markers}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ data }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Winter"}\NormalTok{),}
              \DataTypeTok{x =} \OperatorTok{~}\NormalTok{tempOa,}
              \DataTypeTok{y =} \OperatorTok{~}\NormalTok{tempR,}
              \DataTypeTok{name =} \StringTok{"Winter"}\NormalTok{,}
              \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#365c8d"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.1}\NormalTok{),}
              \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
              \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"TempR:   "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempR),}
                             \StringTok{"<br />TempOa: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f \textbackslash{}u00B0C"}\NormalTok{, tempOa),}
                             \StringTok{"<br />Date:       "}\NormalTok{, time,}
                             \StringTok{"<br />Season:  "}\NormalTok{, season}
\NormalTok{              )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{layout}\NormalTok{(}
    \DataTypeTok{title =} \StringTok{"Thermal Comfort according to SIA 180:2014"}\NormalTok{,}
    \DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Moving average outdoor temperature over last 48 hours (\textbackslash{}u00B0C)"}\NormalTok{,}
                 \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(minx, maxx),}
                 \DataTypeTok{zeroline =} \OtherTok{FALSE}\NormalTok{,}
                 \DataTypeTok{tick0 =}\NormalTok{ minx,}
                 \DataTypeTok{dtick =} \DecValTok{2}\NormalTok{,}
                 \DataTypeTok{titlefont =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{size =} \DecValTok{14}\NormalTok{, }\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{)),}
    \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Room Temperature (\textbackslash{}u00B0C)"}\NormalTok{,}
                 \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(miny, maxy),}
                 \DataTypeTok{dtick =} \DecValTok{1}\NormalTok{,}
                 \DataTypeTok{titlefont =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{size =} \DecValTok{14}\NormalTok{, }\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{)),}
    \DataTypeTok{hoverlabel =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{align =} \StringTok{"left"}\NormalTok{),}
    \DataTypeTok{margin =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{l =} \DecValTok{80}\NormalTok{, }\DataTypeTok{t =} \DecValTok{50}\NormalTok{, }\DataTypeTok{r =} \DecValTok{50}\NormalTok{, }\DataTypeTok{b =} \DecValTok{10}\NormalTok{),}
    \DataTypeTok{legend =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{orientation =} \StringTok{'h'}\NormalTok{,}
                  \DataTypeTok{x =} \FloatTok{0.0}\NormalTok{,}
                  \DataTypeTok{y =} \FloatTok{-0.3}\NormalTok{)}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }
\StringTok{  }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{config}\NormalTok{(}\DataTypeTok{modeBarButtons =} \KeywordTok{list}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)),}
                 \DataTypeTok{displaylogo =} \OtherTok{FALSE}\NormalTok{,}
                 \DataTypeTok{toImageButtonOptions =} \KeywordTok{list}\NormalTok{(}
                   \DataTypeTok{format =} \StringTok{"png"}
\NormalTok{                 )}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/comfortSia180ThermCmf1-1.pdf}

\hypertarget{miscellaneous}{%
\chapter{Miscellaneous}\label{miscellaneous}}

Finally, some visualizations that did not fit into any of the above chapters and are not (yet) worth a separate chapter. But these are not less interesting\ldots{}

\newpage

\hypertarget{electricity-household}{%
\section{Electricity Household}\label{electricity-household}}

\hypertarget{goal-14}{%
\subsection{Goal}\label{goal-14}}

You want to plot an electricity consumption diagram with:

\begin{itemize}
\tightlist
\item
  upper plot with daily energy consumption in kWh/day
\item
  lower plot with standby-losses in Watts
\end{itemize}

Additionaly we would like to see the consumption of an average Swiss household.

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/eleHousehold} \caption{Plot Electricity Household}\label{fig:unnamed-chunk-24}
\end{figure}

\hypertarget{data-basis-14}{%
\subsection{Data Basis}\label{data-basis-14}}

\begin{itemize}
\tightlist
\item
  A csv file with time series of an electric meter in 15 minute interval.
\end{itemize}

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/eleHousehold10-1.pdf}
\caption{\label{fig:eleHousehold10}Raw Data for Electricity Household Plot}
\end{figure}

\hypertarget{solution-14}{%
\subsection{Solution}\label{solution-14}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(zoo)}
\KeywordTok{library}\NormalTok{(plotly)}

\CommentTok{# load time series data and aggregate mean values}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatElectricity.csv"}\NormalTok{,}
               \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{df}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(df}\OperatorTok{$}\NormalTok{time,}
                           \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                           \DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{)}

\CommentTok{# select room}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(time, FlatC_Ele)}

\CommentTok{# rename columns}
\KeywordTok{colnames}\NormalTok{(df) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"timestamp"}\NormalTok{, }\StringTok{"meterValue"}\NormalTok{)}

\CommentTok{# filter timerange}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(timestamp }\OperatorTok{>}\StringTok{ "2019-07-01"}\NormalTok{)}

\CommentTok{# Fill missing values with NA}
\NormalTok{grid.df <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{timestamp =} \KeywordTok{seq}\NormalTok{(}\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                      \KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{timestamp, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{),}
                                      \DataTypeTok{by =} \StringTok{"15 mins"}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(df, grid.df, }\DataTypeTok{all =} \OtherTok{TRUE}\NormalTok{)}

\CommentTok{# convert steadily counting energy meter value from kWh to power in kW}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{value =}\NormalTok{ (meterValue }\OperatorTok{-}\StringTok{ }\KeywordTok{lag}\NormalTok{(meterValue))) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{meterValue)}

\CommentTok{# remove negative values which occur beause of change summer/winter time}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(value }\OperatorTok{>=}\StringTok{ }\DecValTok{0}\NormalTok{)}

\CommentTok{# determine date related parameters for later filtering}
\NormalTok{df}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{tz =} \StringTok{"UTC"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{week <-}\StringTok{ }\NormalTok{lubridate}\OperatorTok{::}\KeywordTok{week}\NormalTok{(df}\OperatorTok{$}\NormalTok{time)}
\NormalTok{df}\OperatorTok{$}\NormalTok{month <-}\StringTok{ }\NormalTok{lubridate}\OperatorTok{::}\KeywordTok{month}\NormalTok{(df}\OperatorTok{$}\NormalTok{time)}
\NormalTok{df}\OperatorTok{$}\NormalTok{year <-}\StringTok{ }\NormalTok{lubridate}\OperatorTok{::}\KeywordTok{year}\NormalTok{(df}\OperatorTok{$}\NormalTok{time)}

\CommentTok{# data cleansing}
\CommentTok{# tag NA}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{deleteNA =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(value),}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{))}

\CommentTok{# tag values below 0 and higher than 9.2 kW}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{deleteHiLoVal =} \KeywordTok{ifelse}\NormalTok{(value }\OperatorTok{>}\StringTok{ }\FloatTok{9.2}\NormalTok{,}\DecValTok{1}\NormalTok{, }\KeywordTok{ifelse}\NormalTok{(value }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{)))}
\CommentTok{# Assumption max. fuse 40 ampere (higher fuses for single family houses)}
\CommentTok{# this results in continuous power 9.2 kW}
\CommentTok{# this results in an hourly consumption of 9.2kWh}
\CommentTok{# over 24h = approx. 221 kWh max. consumption per day}

\CommentTok{# tag whole days which have one or more values to delete, keep only whole valid days}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{delete =} \KeywordTok{sum}\NormalTok{(deleteNA, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{+}\StringTok{ }\KeywordTok{sum}\NormalTok{(deleteHiLoVal, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{))}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{ungroup}\NormalTok{()}

\CommentTok{# delete full days with invalid data}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(delete }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{deleteNA, }\OperatorTok{-}\NormalTok{deleteHiLoVal, }\OperatorTok{-}\NormalTok{delete)}

\CommentTok{# determine season for later filtering}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{season =}\NormalTok{ redutils}\OperatorTok{::}\KeywordTok{getSeason}\NormalTok{(timestamp))}

\CommentTok{# calculate sum and min per day}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{sum =} \KeywordTok{sum}\NormalTok{(value))}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{min =} \KeywordTok{min}\NormalTok{(value)}\OperatorTok{*}\DecValTok{1000}\OperatorTok{*}\DecValTok{4}\NormalTok{)}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{ungroup}\NormalTok{()}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{select}\NormalTok{(day, sum, min, season) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{()}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{ravgUsage =}\NormalTok{ zoo}\OperatorTok{::}\KeywordTok{rollmean}\NormalTok{(}\DataTypeTok{x=}\NormalTok{sum, }\DecValTok{7}\NormalTok{, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{))}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\NormalTok{dplyr}\OperatorTok{::}\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{rminStandby =} \DecValTok{-1} \OperatorTok{*}\StringTok{ }\NormalTok{zoo}\OperatorTok{::}\KeywordTok{rollmaxr}\NormalTok{(}\DataTypeTok{x =} \DecValTok{-1} \OperatorTok{*}\StringTok{ }\NormalTok{min, }\DecValTok{7}\NormalTok{, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{))}

\NormalTok{typEleConsVal <-}\StringTok{ }\NormalTok{redutils}\OperatorTok{::}\KeywordTok{getTypEleConsHousehold}\NormalTok{(}\DataTypeTok{occupants =} \DecValTok{2}\NormalTok{, }\DataTypeTok{rooms =} \FloatTok{3.5}\NormalTok{, }\DataTypeTok{bldgType =} \StringTok{"multi"}\NormalTok{, }\DataTypeTok{laundry =} \StringTok{"hotWaterSupply"}\NormalTok{)}\OperatorTok{/}\DecValTok{365}


\CommentTok{# Plot}
\NormalTok{main =}\StringTok{ "Electricity consumption private household"}
\NormalTok{minY <-}\StringTok{ }\DecValTok{0}
\NormalTok{maxYUsage <-}\StringTok{ }\KeywordTok{max}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(sum), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{maxYUsage <-}\StringTok{ }\KeywordTok{max}\NormalTok{(maxYUsage, typEleConsVal}\OperatorTok{/}\DecValTok{365}\NormalTok{)}
\NormalTok{maxYStandby <-}\StringTok{ }\KeywordTok{max}\NormalTok{(}\KeywordTok{max}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(min), }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{), }\FloatTok{0.25}\OperatorTok{*}\NormalTok{maxYUsage}\OperatorTok{/}\DecValTok{24}\OperatorTok{*}\DecValTok{1000}\NormalTok{)}
\NormalTok{minX <-}\StringTok{ }\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{day)}
\NormalTok{maxX <-}\StringTok{ }\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{day)}
\NormalTok{averageUsage <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(df}\OperatorTok{$}\NormalTok{sum, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{averageStandby <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(df}\OperatorTok{$}\NormalTok{rminStandby, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{shareStandby <-}\StringTok{ }\KeywordTok{nrow}\NormalTok{(df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(sum) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()) }\OperatorTok{*}\StringTok{ }\NormalTok{averageStandby }\OperatorTok{*}\StringTok{ }\DecValTok{24} \OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{1000} \OperatorTok{*}\StringTok{ }\KeywordTok{sum}\NormalTok{(df}\OperatorTok{$}\NormalTok{sum, }\DataTypeTok{na.rm=}\OtherTok{TRUE}\NormalTok{)) }\OperatorTok{*}\StringTok{ }\DecValTok{100}

\CommentTok{# legend}
\NormalTok{l <-}\StringTok{ }\KeywordTok{list}\NormalTok{(}
  \DataTypeTok{orientation =} \StringTok{"h"}\NormalTok{,}
  \DataTypeTok{tracegroupgap =} \StringTok{"20"}\NormalTok{,}
  \DataTypeTok{font =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{size =} \DecValTok{8}\NormalTok{),}
  \DataTypeTok{xanchor =} \StringTok{"center"}\NormalTok{,}
  \DataTypeTok{x =} \FloatTok{0.5}\NormalTok{,}
  \DataTypeTok{itemclick =} \OtherTok{FALSE}
\NormalTok{)}

\NormalTok{fig1 <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{plot_ly}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{day, }\DataTypeTok{showlegend =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Spring"}\NormalTok{),}
            \DataTypeTok{type =} \StringTok{"bar"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{sum,}
            \DataTypeTok{name =} \StringTok{"Spring"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group1"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#2db27d"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.2}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />daily usage:              "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, sum),}
                           \StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Summer"}\NormalTok{),}
            \DataTypeTok{type =} \StringTok{"bar"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{sum,}
            \DataTypeTok{name =} \StringTok{"Summer"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group1"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#febc2b"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.2}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Fall"}\NormalTok{),}
            \DataTypeTok{type =} \StringTok{"bar"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{sum,}
            \DataTypeTok{name =} \StringTok{"Fall"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group1"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#440154"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.2}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(season }\OperatorTok{==}\StringTok{ "Winter"}\NormalTok{),}
            \DataTypeTok{type =} \StringTok{"bar"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{sum,}
            \DataTypeTok{name =} \StringTok{"Winter"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group1"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#365c8d"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.2}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df,}
            \DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{,}
            \DataTypeTok{mode =} \StringTok{"markers"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{ravgUsage,}
            \DataTypeTok{name =} \StringTok{"Average Cons. (7 days)"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group2"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"orange"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.4}\NormalTok{, }\DataTypeTok{symbol =} \StringTok{"circle"}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_segments}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{minX,}
               \DataTypeTok{xend =} \OperatorTok{~}\NormalTok{maxX,}
               \DataTypeTok{y =} \OperatorTok{~}\NormalTok{averageUsage,}
               \DataTypeTok{yend =} \OperatorTok{~}\NormalTok{averageUsage,}
               \DataTypeTok{name =} \StringTok{"Average Cons. Total"}\NormalTok{,}
               \DataTypeTok{legendgroup =} \StringTok{"group2"}\NormalTok{,}
               \DataTypeTok{line =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"orange"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{1.0}\NormalTok{, }\DataTypeTok{dash =} \StringTok{"dot"}\NormalTok{),}
               \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
               \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, ravgUsage),}
                              \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage),}
                              \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                              \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{               )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_segments}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{minX,}
               \DataTypeTok{xend =} \OperatorTok{~}\NormalTok{maxX,}
               \DataTypeTok{y =} \OperatorTok{~}\NormalTok{averageStandby}\OperatorTok{*}\DecValTok{24}\OperatorTok{/}\DecValTok{1000}\NormalTok{,}
               \DataTypeTok{yend =} \OperatorTok{~}\NormalTok{averageStandby}\OperatorTok{*}\DecValTok{24}\OperatorTok{/}\DecValTok{1000}\NormalTok{,}
               \DataTypeTok{name =} \StringTok{"Average Standby Total"}\NormalTok{,}
               \DataTypeTok{legendgroup =} \StringTok{"group3"}\NormalTok{,}
               \DataTypeTok{showlegend =} \OtherTok{FALSE}\NormalTok{,}
               \DataTypeTok{line =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{1.0}\NormalTok{, }\DataTypeTok{dash =} \StringTok{"dot"}\NormalTok{),}
               \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
               \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />Average standby power:          "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, averageStandby),}
                              \StringTok{"<br />equals to daily energy:         "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh"}\NormalTok{, averageStandby}\OperatorTok{*}\DecValTok{24}\OperatorTok{/}\DecValTok{1000}\NormalTok{),}
                              \StringTok{"<br />Standby percent of total cons.: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f %%"}\NormalTok{, shareStandby)}
\NormalTok{               )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_segments}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{minX,}
               \DataTypeTok{xend =} \OperatorTok{~}\NormalTok{maxX,}
               \DataTypeTok{y =} \OperatorTok{~}\NormalTok{typEleConsVal,}
               \DataTypeTok{yend =} \OperatorTok{~}\NormalTok{typEleConsVal,}
               \DataTypeTok{name =} \StringTok{"typical household"}\NormalTok{,}
               \DataTypeTok{legendgroup =} \StringTok{"group4"}\NormalTok{,}
               \DataTypeTok{line =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#481567FF"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{1.0}\NormalTok{, }\DataTypeTok{dash =} \StringTok{"dot"}\NormalTok{),}
               \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
               \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />typical household:           "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f kWh/year"}\NormalTok{, typEleConsVal}\OperatorTok{*}\DecValTok{365}\NormalTok{),}
                              \StringTok{"<br />equals to daily energy:      "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/day"}\NormalTok{, typEleConsVal),}
                              \StringTok{"<br />consumption of current flat: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/day"}\NormalTok{, averageUsage)}
\NormalTok{               )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_annotations}\NormalTok{(}
    \DataTypeTok{x =}\NormalTok{ minX,}
    \DataTypeTok{y =}\NormalTok{ typEleConsVal,}
    \DataTypeTok{text =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"typical comparable household "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, typEleConsVal)),}
    \DataTypeTok{xref =} \StringTok{"x"}\NormalTok{,}
    \DataTypeTok{yref =} \StringTok{"y"}\NormalTok{,}
    \DataTypeTok{showarrow =} \OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{arrowhead =} \DecValTok{7}\NormalTok{,}
    \DataTypeTok{ax =} \DecValTok{100}\NormalTok{,}
    \DataTypeTok{ay =} \DecValTok{-20}\NormalTok{,}
    \DataTypeTok{font =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"#481567FF"}\NormalTok{)}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_annotations}\NormalTok{(}
    \DataTypeTok{x =}\NormalTok{ maxX,}
    \DataTypeTok{y =}\NormalTok{ averageUsage,}
    \DataTypeTok{text =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"Average consumption "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh/d"}\NormalTok{, averageUsage)),}
    \DataTypeTok{xref =} \StringTok{"x"}\NormalTok{,}
    \DataTypeTok{yref =} \StringTok{"y"}\NormalTok{,}
    \DataTypeTok{showarrow =} \OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{arrowhead =} \DecValTok{7}\NormalTok{,}
    \DataTypeTok{ax =} \DecValTok{-100}\NormalTok{,}
    \DataTypeTok{ay =} \DecValTok{-60}\NormalTok{,}
    \DataTypeTok{font =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"orange"}\NormalTok{)}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_annotations}\NormalTok{(}
    \DataTypeTok{x =}\NormalTok{ maxX,}
    \DataTypeTok{y =}\NormalTok{ averageStandby}\OperatorTok{*}\DecValTok{24}\OperatorTok{/}\DecValTok{1000}\NormalTok{,}
    \DataTypeTok{text =} \KeywordTok{paste0}\NormalTok{(}\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f %%"}\NormalTok{, shareStandby), }\StringTok{" of the consumption are standby-losses"}\NormalTok{),}
    \DataTypeTok{xref =} \StringTok{"x"}\NormalTok{,}
    \DataTypeTok{yref =} \StringTok{"y"}\NormalTok{,}
    \DataTypeTok{showarrow =} \OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{arrowhead =} \DecValTok{7}\NormalTok{,}
    \DataTypeTok{ax =} \DecValTok{-160}\NormalTok{,}
    \DataTypeTok{ay =} \DecValTok{-15}\NormalTok{,}
    \DataTypeTok{font =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{layout}\NormalTok{(}
    \DataTypeTok{title =}\NormalTok{ main,}
    \DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}
      \DataTypeTok{title =} \StringTok{""}
\NormalTok{    ),}
    \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Consumption<br>(kWh/d)"}\NormalTok{,}
                 \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(minY, maxYUsage),}
                 \DataTypeTok{titlefont =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{size =} \DecValTok{14}\NormalTok{, }\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{)),}
    \DataTypeTok{hoverlabel =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{align =} \StringTok{"left"}\NormalTok{),}
    \DataTypeTok{margin =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{l =} \DecValTok{80}\NormalTok{, }\DataTypeTok{t =} \DecValTok{50}\NormalTok{, }\DataTypeTok{r =} \DecValTok{50}\NormalTok{, }\DataTypeTok{b =} \DecValTok{10}\NormalTok{),}
    \DataTypeTok{legend =}\NormalTok{ l}
\NormalTok{  )}

\NormalTok{fig2 <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{plot_ly}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{day, }\DataTypeTok{showlegend =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df,}
            \DataTypeTok{type =} \StringTok{"bar"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{min,}
            \DataTypeTok{name =} \StringTok{"Daily standby-losses"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group3"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.2}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />daily standby:           "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, min),}
                           \StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, rminStandby),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, averageStandby),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_trace}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ df,}
            \DataTypeTok{type =} \StringTok{"scatter"}\NormalTok{,}
            \DataTypeTok{mode =} \StringTok{"markers"}\NormalTok{,}
            \DataTypeTok{y =} \OperatorTok{~}\NormalTok{rminStandby,}
            \DataTypeTok{name =} \StringTok{"Average Standby (7 days)"}\NormalTok{,}
            \DataTypeTok{legendgroup =} \StringTok{"group3"}\NormalTok{,}
            \DataTypeTok{marker =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{0.5}\NormalTok{, }\DataTypeTok{symbol =} \StringTok{"circle"}\NormalTok{),}
            \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
            \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />daily standby:           "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, min),}
                           \StringTok{"<br />rolling average:        "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, rminStandby),}
                           \StringTok{"<br />Average vis. points: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, averageStandby),}
                           \StringTok{"<br />Date:                        "}\NormalTok{, day,}
                           \StringTok{"<br />Season:                   "}\NormalTok{, season}
\NormalTok{            )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_segments}\NormalTok{(}\DataTypeTok{x =} \OperatorTok{~}\NormalTok{minX,}
               \DataTypeTok{xend =} \OperatorTok{~}\NormalTok{maxX,}
               \DataTypeTok{y =} \OperatorTok{~}\NormalTok{averageStandby,}
               \DataTypeTok{yend =} \OperatorTok{~}\NormalTok{averageStandby,}
               \DataTypeTok{name =} \StringTok{"Average Standby Total"}\NormalTok{,}
               \DataTypeTok{legendgroup =} \StringTok{"group3"}\NormalTok{,}
               \DataTypeTok{line =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{opacity =} \FloatTok{1.0}\NormalTok{, }\DataTypeTok{dash =} \StringTok{"dot"}\NormalTok{),}
               \DataTypeTok{hoverinfo =} \StringTok{"text"}\NormalTok{,}
               \DataTypeTok{text =} \OperatorTok{~}\StringTok{ }\KeywordTok{paste}\NormalTok{(}\StringTok{"<br />Average standby power:          "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, averageStandby),}
                              \StringTok{"<br />equals to daily energy:         "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.1f kWh"}\NormalTok{, averageStandby}\OperatorTok{*}\DecValTok{24}\OperatorTok{/}\DecValTok{1000}\NormalTok{),}
                              \StringTok{"<br />Standby percent of total cons.: "}\NormalTok{, }\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f %%"}\NormalTok{, shareStandby)}
\NormalTok{               )}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_annotations}\NormalTok{(}
    \DataTypeTok{x =}\NormalTok{ maxX,}
    \DataTypeTok{y =}\NormalTok{ averageStandby,}
    \DataTypeTok{text =} \KeywordTok{paste0}\NormalTok{(}\KeywordTok{sprintf}\NormalTok{(}\StringTok{"%.0f W"}\NormalTok{, averageStandby), }\StringTok{" standby-losses on average"}\NormalTok{),}
    \DataTypeTok{xref =} \StringTok{"x"}\NormalTok{,}
    \DataTypeTok{yref =} \StringTok{"y"}\NormalTok{,}
    \DataTypeTok{showarrow =} \OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{arrowhead =} \DecValTok{7}\NormalTok{,}
    \DataTypeTok{ax =} \DecValTok{-60}\NormalTok{,}
    \DataTypeTok{ay =} \DecValTok{-20}\NormalTok{,}
    \DataTypeTok{font =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{color =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{layout}\NormalTok{(}
    \DataTypeTok{title =} \StringTok{"Electricity Household"}\NormalTok{,}
    \DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}
      \DataTypeTok{title =} \StringTok{""}
\NormalTok{    ),}
    \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{" Standby<br>(W)"}\NormalTok{,}
                 \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(minY, maxYStandby),}
                 \DataTypeTok{titlefont =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{size =} \DecValTok{14}\NormalTok{, }\DataTypeTok{color =} \StringTok{"darkgrey"}\NormalTok{),}
                 \DataTypeTok{legend =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{orientation =} \StringTok{'h'}\NormalTok{)),}
    \DataTypeTok{legend =}\NormalTok{ l}
\NormalTok{  )}

\CommentTok{# calculate ratio which is visual representative for comparison }
\CommentTok{# ratio <- 1/maxYUsage * maxYStandby * 24 / 1000}
\NormalTok{ratio <-}\StringTok{ }\FloatTok{0.3}
\NormalTok{fig <-}\StringTok{ }\KeywordTok{subplot}\NormalTok{(fig1, fig2, }\DataTypeTok{nrows =} \DecValTok{2}\NormalTok{, }\DataTypeTok{shareX =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{heights =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\OperatorTok{-}\NormalTok{ratio, ratio), }\DataTypeTok{titleY =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{config}\NormalTok{(}\DataTypeTok{modeBarButtons =} \KeywordTok{list}\NormalTok{(}\KeywordTok{list}\NormalTok{(}\StringTok{"toImage"}\NormalTok{)),}
                 \DataTypeTok{displaylogo =} \OtherTok{FALSE}\NormalTok{,}
                 \DataTypeTok{toImageButtonOptions =} \KeywordTok{list}\NormalTok{(}
                   \DataTypeTok{format =} \StringTok{"png"}
\NormalTok{                 )}
\NormalTok{  )}
\NormalTok{fig}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/eleHousehold1-1.pdf}

\newpage

\hypertarget{room-temperature-reduction}{%
\section{Room Temperature Reduction}\label{room-temperature-reduction}}

\hypertarget{goal-15}{%
\subsection{Goal}\label{goal-15}}

As part of an energy optimization, you lower the room temperatures in a room and would now like to show the reduction effect using the time series of the room temperature sensor. In the example below you make two optimizations at different dates.

You want to create a time series plot with

\begin{itemize}
\item
  the daily median, min and max value
\item
  the overall median of each period
\item
  the desired setpoint
\end{itemize}

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/roomTempRed} \caption{Room Temperature Reduction Plot}\label{fig:unnamed-chunk-25}
\end{figure}

\hypertarget{data-basis-15}{%
\subsection{Data Basis}\label{data-basis-15}}

\begin{itemize}
\tightlist
\item
  Time series data from e.g.~a temperature sensor with unaligned time intervals
\end{itemize}

\begin{figure}
\centering
\includegraphics{edar_files/figure-latex/roomTempRed0-1.pdf}
\caption{\label{fig:roomTempRed0}Raw Data Temperature for Room Temperature Reduction Plot}
\end{figure}

\hypertarget{solution-15}{%
\subsection{Solution}\label{solution-15}}

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(lubridate)}
\KeywordTok{library}\NormalTok{(dygraphs)}
\KeywordTok{library}\NormalTok{(xts)}
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(RColorBrewer)}

\CommentTok{# Settings}
\NormalTok{tempSetpoint =}\StringTok{ }\FloatTok{22.0}

\NormalTok{startDate =}\StringTok{ "2018-11-01"}
\NormalTok{endDate =}\StringTok{ "2019-02-01"}

\NormalTok{optiDate1 =}\StringTok{ "2018-12-17"}
\NormalTok{optiLabel1 =}\StringTok{ "Optimization I"}

\NormalTok{optiDate2 =}\StringTok{ "2019-01-03"}
\NormalTok{optiLabel2 =}\StringTok{ "Optimization II"}

\NormalTok{optiDelayDays =}\StringTok{ }\DecValTok{5}

\CommentTok{# read and print data}
\NormalTok{df <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/flatTempHum.csv"}\NormalTok{,}
                 \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                 \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\CommentTok{# select temperature and remove empty cells}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(time, FlatA_Temp) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# create column with day for later grouping}
\NormalTok{df}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\StringTok{"YmdHMS"}\NormalTok{, }\DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}
\NormalTok{df}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(df}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"day"}\NormalTok{))}
\NormalTok{df}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{as.character}\NormalTok{(df}\OperatorTok{$}\NormalTok{day,}\StringTok{"%Y-%m-%d"}\NormalTok{))}

\CommentTok{# filter time range}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(day }\OperatorTok{>}\StringTok{ }\NormalTok{startDate, day }\OperatorTok{<}\StringTok{ }\NormalTok{endDate)}

\CommentTok{# calculate daily median, min and max of temperature}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{minDay =} \KeywordTok{min}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(FlatA_Temp)),}
         \DataTypeTok{medianDay =} \KeywordTok{median}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(FlatA_Temp)),}
         \DataTypeTok{maxDay =} \KeywordTok{max}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(FlatA_Temp))}
\NormalTok{         ) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}

\CommentTok{# shrink down to daily values and remove rows with empty values}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{select}\NormalTok{(day, medianDay, minDay, maxDay) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# calculate medians for time ranges}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{period =} \KeywordTok{ifelse}\NormalTok{(day }\OperatorTok{>=}\StringTok{ }\NormalTok{startDate }\OperatorTok{&}\StringTok{ }\NormalTok{day }\OperatorTok{<=}\StringTok{ }\NormalTok{optiDate1,}
                         \StringTok{"Baseline"}\NormalTok{,}
                         \KeywordTok{ifelse}\NormalTok{((day }\OperatorTok{>=}\StringTok{ }\NormalTok{(}\KeywordTok{as.Date}\NormalTok{(optiDate1) }\OperatorTok{+}\StringTok{ }\NormalTok{optiDelayDays))}
                                \OperatorTok{&}\StringTok{ }\NormalTok{(day }\OperatorTok{<=}\StringTok{ }\NormalTok{optiDate2),}
                                \StringTok{"Opti1"}\NormalTok{,}
                                \KeywordTok{ifelse}\NormalTok{((day }\OperatorTok{>=}\StringTok{ }\NormalTok{(}\KeywordTok{as.Date}\NormalTok{(optiDate2) }\OperatorTok{+}\StringTok{ }\NormalTok{optiDelayDays))}
                                \OperatorTok{&}\StringTok{ }\NormalTok{(day }\OperatorTok{<=}\StringTok{ }\NormalTok{endDate),}
                                \StringTok{"Opti2"}\NormalTok{,}
                                \OtherTok{NA}\NormalTok{)}
\NormalTok{                         )))}

\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(period) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{medianPeriod =} \KeywordTok{ifelse}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(period), }\OtherTok{NA}\NormalTok{, }\KeywordTok{median}\NormalTok{(medianDay))) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ungroup}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{period)}

\CommentTok{# create xts object for plotting}
\NormalTok{plotdata <-}\StringTok{ }\KeywordTok{xts}\NormalTok{( }\DataTypeTok{x=}\NormalTok{df[,}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\DataTypeTok{order.by=}\NormalTok{df}\OperatorTok{$}\NormalTok{day)}

\CommentTok{# plot graph}
\KeywordTok{dygraph}\NormalTok{(plotdata, }\DataTypeTok{main =} \StringTok{"Room Temperature Reduction"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dyAxis}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\DataTypeTok{drawGrid =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dySeries}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"minDay"}\NormalTok{, }\StringTok{"medianDay"}\NormalTok{, }\StringTok{"maxDay"}\NormalTok{),}
           \DataTypeTok{label =} \StringTok{"Temperature"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dySeries}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"medianPeriod"}\NormalTok{),}
           \DataTypeTok{label =} \StringTok{"Median Period"}\NormalTok{,}
           \DataTypeTok{strokePattern =} \StringTok{"dashed"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dyOptions}\NormalTok{(}\DataTypeTok{colors =}\NormalTok{ RColorBrewer}\OperatorTok{::}\KeywordTok{brewer.pal}\NormalTok{(}\DecValTok{3}\NormalTok{, }\StringTok{"Set2"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{dyEvent}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ optiDate1,}
          \DataTypeTok{label =}\NormalTok{ optiLabel1,}
          \DataTypeTok{labelLoc =} \StringTok{"bottom"}\NormalTok{,}
          \DataTypeTok{color =} \StringTok{"slategray"}\NormalTok{,}
          \DataTypeTok{strokePattern =} \StringTok{"dotted"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{dyEvent}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ optiDate2,}
          \DataTypeTok{label =}\NormalTok{ optiLabel2,}
          \DataTypeTok{labelLoc =} \StringTok{"bottom"}\NormalTok{,}
          \DataTypeTok{color =} \StringTok{"slategray"}\NormalTok{,}
          \DataTypeTok{strokePattern =} \StringTok{"dotted"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{dyLimit}\NormalTok{(tempSetpoint,}
          \DataTypeTok{color =} \StringTok{"red"}\NormalTok{,}
          \DataTypeTok{label =} \StringTok{"Target Setpoint"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{dyRangeSelector}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{dyLegend}\NormalTok{(}\DataTypeTok{show =} \StringTok{"always"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/roomTempRed1-1.pdf}

\hypertarget{discussion-7}{%
\subsection{Discussion}\label{discussion-7}}

In this example we used the dygraph package to create the graph. This package is fast and allows to show a rangeslider on the bottom of the graph. The exact same graph but without a slider is as well possible with ggplot.

Please note that the calculation of the periodic median after optimization I and II starts delayed because it takes time until the building has cooled down.

\newpage

\hypertarget{building-energy-signature}{%
\section{Building Energy Signature}\label{building-energy-signature}}

\hypertarget{goal-16}{%
\subsection{Goal}\label{goal-16}}

You want to create a scatter plot with

\begin{itemize}
\item
  the daily mean outside temperature on the x-axis
\item
  the daily energy consumption on the y-axis
\item
  points colored according to season
\end{itemize}

\begin{figure}
\includegraphics[width=0.7\linewidth]{images/plotBldgEngySigScatter} \caption{Building Energy Signature Plot}\label{fig:unnamed-chunk-26}
\end{figure}

\hypertarget{data-basis-16}{%
\subsection{Data Basis}\label{data-basis-16}}

Two separate csv files with time series data from the outside temperature and the energy data with unaligned time intervals:

\includegraphics{edar_files/figure-latex/energysignature0-1.pdf}
\includegraphics{edar_files/figure-latex/energysignature1-1.pdf}

\hypertarget{solution-16}{%
\subsection{Solution}\label{solution-16}}

After reading in the two time series the data has to get aggregated per day and then merged. Note that during the aggregation of the energy data you have to calculate the daily conspumption from the steadiliy increasing meter values as well.

Create a new script, copy/paste the following code and run it:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2)}
\KeywordTok{library}\NormalTok{(plotly)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(redutils)}
\KeywordTok{library}\NormalTok{(lubridate)}
\CommentTok{# load time series data and aggregate daily mean values}
\NormalTok{dfOutsideTemp <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/centralOutsideTemp.csv"}\NormalTok{,}
                          \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                          \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfOutsideTemp}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfOutsideTemp}\OperatorTok{$}\NormalTok{time,}
                                      \DataTypeTok{order =} \StringTok{"YmdHMS"}\NormalTok{,}
                                      \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\NormalTok{dfOutsideTemp}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(dfOutsideTemp}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"day"}\NormalTok{))}
\NormalTok{dfOutsideTemp <-}\StringTok{ }\NormalTok{dfOutsideTemp }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{tempMean =} \KeywordTok{mean}\NormalTok{(centralOutsideTemp)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}

\NormalTok{dfOutsideTemp <-}\StringTok{ }\NormalTok{dfOutsideTemp }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(day, tempMean) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}

\NormalTok{dfHeatEnergy <-}\StringTok{ }\KeywordTok{read.csv}\NormalTok{(}\StringTok{"https://github.com/hslu-ige-laes/edar/raw/master/sampleData/centralHeating.csv"}\NormalTok{,}
                         \DataTypeTok{stringsAsFactors=}\OtherTok{FALSE}\NormalTok{,}
                         \DataTypeTok{sep =}\StringTok{";"}\NormalTok{)}

\NormalTok{dfHeatEnergy <-}\StringTok{ }\NormalTok{dfHeatEnergy }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(time, energyHeatingMeter) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}

\NormalTok{dfHeatEnergy}\OperatorTok{$}\NormalTok{time <-}\StringTok{ }\KeywordTok{parse_date_time}\NormalTok{(dfHeatEnergy}\OperatorTok{$}\NormalTok{time,}
                                     \DataTypeTok{orders =} \StringTok{"YmdHMS"}\NormalTok{,}
                                     \DataTypeTok{tz =} \StringTok{"Europe/Zurich"}\NormalTok{)}

\NormalTok{dfHeatEnergy}\OperatorTok{$}\NormalTok{day <-}\StringTok{ }\KeywordTok{as.Date}\NormalTok{(}\KeywordTok{cut}\NormalTok{(dfHeatEnergy}\OperatorTok{$}\NormalTok{time, }\DataTypeTok{breaks =} \StringTok{"day"}\NormalTok{))}
\NormalTok{dfHeatEnergy <-}\StringTok{ }\NormalTok{dfHeatEnergy }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(day) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{energyMax =} \KeywordTok{max}\NormalTok{(energyHeatingMeter)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ungroup}\NormalTok{()}

\NormalTok{dfHeatEnergy <-}\StringTok{ }\NormalTok{dfHeatEnergy }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(day, energyMax) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}

\NormalTok{dfHeatEnergy <-}\StringTok{ }\NormalTok{dfHeatEnergy }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{energyCons =}\NormalTok{ energyMax }\OperatorTok{-}\StringTok{ }\KeywordTok{lag}\NormalTok{(energyMax)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{energyMax) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{na.omit}\NormalTok{()}

\CommentTok{# merge the data in a tidy format}
\NormalTok{df <-}\StringTok{ }\KeywordTok{merge}\NormalTok{(dfOutsideTemp, dfHeatEnergy, }\DataTypeTok{by =} \StringTok{"day"}\NormalTok{)}

\CommentTok{# calculate season}
\NormalTok{df <-}\StringTok{ }\NormalTok{df }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{season =}\NormalTok{ redutils}\OperatorTok{::}\KeywordTok{getSeason}\NormalTok{(df}\OperatorTok{$}\NormalTok{day))}

\CommentTok{# static chart with ggplot}
\NormalTok{plot <-}\StringTok{ }\NormalTok{ggplot2}\OperatorTok{::}\KeywordTok{ggplot}\NormalTok{(df) }\OperatorTok{+}
\StringTok{  }\NormalTok{ggplot2}\OperatorTok{::}\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ tempMean,}
                          \DataTypeTok{y =}\NormalTok{ energyCons,}
                          \DataTypeTok{color =}\NormalTok{ season,}
                          \DataTypeTok{alpha =} \FloatTok{0.1}\NormalTok{,}
                          \DataTypeTok{text =} \KeywordTok{paste}\NormalTok{(}\StringTok{"</br>Date:  "}\NormalTok{, }\KeywordTok{as.Date}\NormalTok{(df}\OperatorTok{$}\NormalTok{day),}
                                       \StringTok{"</br>Temp: "}\NormalTok{, }\KeywordTok{round}\NormalTok{(df}\OperatorTok{$}\NormalTok{tempMean, }\DataTypeTok{digits =} \DecValTok{1}\NormalTok{), }\StringTok{"\textbackslash{}u00B0C"}\NormalTok{,}
                                       \StringTok{"</br>Energy: "}\NormalTok{, }\KeywordTok{round}\NormalTok{(df}\OperatorTok{$}\NormalTok{energyCons, }\DataTypeTok{digits =} \DecValTok{0}\NormalTok{), }\StringTok{"kWh/d"}\NormalTok{,}
                                       \StringTok{"</br>Season: "}\NormalTok{, df}\OperatorTok{$}\NormalTok{season))}
\NormalTok{                      ) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_manual}\NormalTok{(}\DataTypeTok{values=}\KeywordTok{c}\NormalTok{(}\StringTok{"#440154"}\NormalTok{, }\StringTok{"#2db27d"}\NormalTok{, }\StringTok{"#fde725"}\NormalTok{, }\StringTok{"#365c8d"}\NormalTok{)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}\StringTok{"Building Energy Signature"}\NormalTok{) }\OperatorTok{+}
\StringTok{        }\KeywordTok{theme_minimal}\NormalTok{() }\OperatorTok{+}
\StringTok{        }\KeywordTok{theme}\NormalTok{(}
          \DataTypeTok{legend.position=}\StringTok{"none"}\NormalTok{,}
          \DataTypeTok{plot.title =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{hjust =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{        )}

\CommentTok{# interactive chart}
\NormalTok{plotly}\OperatorTok{::}\KeywordTok{ggplotly}\NormalTok{(plot, }\DataTypeTok{tooltip =} \KeywordTok{c}\NormalTok{(}\StringTok{"text"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{layout}\NormalTok{(}\DataTypeTok{xaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Outside temperature (\textbackslash{}u00B0C)"}\NormalTok{,}
                      \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(}\KeywordTok{min}\NormalTok{(}\OperatorTok{-}\DecValTok{5}\NormalTok{,}\KeywordTok{min}\NormalTok{(df}\OperatorTok{$}\NormalTok{tempMean)), }\KeywordTok{max}\NormalTok{(}\DecValTok{35}\NormalTok{,}\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{tempMean))), }\DataTypeTok{zeroline =}\NormalTok{ F),}
         \DataTypeTok{yaxis =} \KeywordTok{list}\NormalTok{(}\DataTypeTok{title =} \StringTok{"Daily energy consumption (kWh/d)"}\NormalTok{,}
                      \DataTypeTok{range =} \KeywordTok{c}\NormalTok{(}\OperatorTok{-}\DecValTok{5}\NormalTok{, }\KeywordTok{max}\NormalTok{(df}\OperatorTok{$}\NormalTok{energyCons) }\OperatorTok{+}\StringTok{ }\DecValTok{10}\NormalTok{)),}
         \DataTypeTok{showlegend =} \OtherTok{TRUE}
\NormalTok{         ) }\OperatorTok{%>%}
\StringTok{  }\NormalTok{plotly}\OperatorTok{::}\KeywordTok{config}\NormalTok{(}\DataTypeTok{displayModeBar =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{displaylogo =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{edar_files/figure-latex/energysignature2-1.pdf}

\hypertarget{discussion-8}{%
\subsection{Discussion}\label{discussion-8}}

This visualization allows a quick detection of malfunctions and provides valuable information on the energy efficiency of the building.

\begin{itemize}
\item
  A constant indoor temperature is assumed.
\item
  It is also assumed that the outside temperature is the parameter with the greatest influence on heating energy consumption.
\item
  This method is suitable for buildings with stable internal heat loads and relatively low passive solar heat loads.
\end{itemize}

\hypertarget{appendix-appendix}{%
\appendix}


\hypertarget{packages}{%
\chapter{Packages in R}\label{packages}}

Many functions of R are not pre-installed and must be loaded manually. R packages are similar to libraries in C, Python etc. An R package bundles useful functions, help files and data sets. You can use these functions within your own R code once you load the package.

The following chapters describe how to install, load, update and use packages.

\newpage

\hypertarget{installing-a-package}{%
\section{Installing a Package}\label{installing-a-package}}

The easiest way to install an R Package is to use the RStudio tab ``Packages'':

\begin{figure}
\includegraphics[width=0.5\linewidth]{images/a2-installPackagesRStudio} \caption{Install packages via RStudio GUI}\label{fig:knitr-logo}
\end{figure}

\begin{enumerate}
\def\labelenumi{\alph{enumi})}
\item
  Click on the ``Packages'' tab
\item
  Click on ``Install'' next to Update
\item
  Type the name of the package under ``Packages, in this case type ggplot2
\item
  Click ``Install''
\end{enumerate}

This will search for the package ``ggplot'' specified on a server (the so-called CRAN website). If the package exists, it will be downloaded to a library folder on your computer. Here R can access the package in future R sessions without having to reinstall it.

An other way is to use the install.packages function.
Open R (if already opened please close all projects) and type the following at the command line:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"ggplot2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

If you want to install a package directly from github, the package ``devtools'' must be installed first:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"devtools"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(devtools)}
\KeywordTok{install_github}\NormalTok{(}\StringTok{"hslu-ige-laes/redutils"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\hypertarget{loading-a-package}{%
\section{Loading a Package}\label{loading-a-package}}

If you have installed a package, its functions are not yet available in your R project. To use an R package in your sript, you must load it with the following command:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"ggplot2"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{upgrading-packages}{%
\section{Upgrading Packages}\label{upgrading-packages}}

R packages are often constantly updated on CRAN or GitHub, so you may want to update them once in a while with:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{update.packages}\NormalTok{(}\DataTypeTok{ask =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{document}
